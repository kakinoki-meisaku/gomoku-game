<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ã‚¢ãƒ¡ãƒŸãƒ¤ãƒã‚«ã¨äº”ç›®ãªã‚‰ã¹)</title>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ENES4Q9772"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ENES4Q9772');
</script>

<script>
// --- ãƒ¢ãƒã‚¤ãƒ«éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒœã‚¤ã‚¹ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ ---

// TIMEOUT_VOICESï¼ˆé…åˆ—ï¼‰ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™ã€‚
const preloadedTimeoutVoices = [];
let audioUnlocked = false;

// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒœã‚¤ã‚¹ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã€ä¸€åº¦å†ç”Ÿã‚’è©¦ã¿ã¦ãƒ­ãƒƒã‚¯è§£é™¤ã‚’ç¢ºå®šã•ã›ã‚‹é–¢æ•°
function preloadVoicesAndUnlock() {
    if (preloadedTimeoutVoices.length > 0) return; // æ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

    if (typeof TIMEOUT_VOICES === 'undefined' || TIMEOUT_VOICES.length === 0) {
        console.warn('TIMEOUT_VOICESãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã‹ç©ºã§ã™ã€‚');
        return;
    }
    
    // TIMEOUT_VOICESå†…ã®ã™ã¹ã¦ã®éŸ³å£°ã‚’Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰
    TIMEOUT_VOICES.forEach((fileName) => {
        const url = VOICE_BASE_URL + fileName; // VOICE_BASE_URLã‚‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚ã‚‹ã“ã¨ã‚’å‰æ
        const audio = new Audio(url);
        audio.load(); // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ä¿ƒã™
        preloadedTimeoutVoices.push(audio);
            // è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        });
    });

    audioUnlocked = true;
    // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ãŒæˆåŠŸã—ãŸã‚‰ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
    document.removeEventListener('touchstart', handleInitialInteraction, true);
    document.removeEventListener('mousedown', handleInitialInteraction, true);
}


// æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆã‚¿ãƒƒãƒã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ï¼‰ã‚’æ•æ‰ã—ã€ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å‡¦ç†ã‚’èµ·å‹•ã™ã‚‹é–¢æ•°
function handleInitialInteraction() {
    if (audioUnlocked) return;
    
    // Web Audio APIã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†é–‹ã‚’è©¦ã¿ã‚‹ï¼ˆã‚ã‚Œã°ï¼‰
    if (window.AudioContext || window.webkitAudioContext) {
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            if (context.state === 'suspended') {
                context.resume().then(preloadVoicesAndUnlock).catch(e => console.error('Context resume failed:', e));
            } else {
                preloadVoicesAndUnlock();
            }
        } catch (e) {
            preloadVoicesAndUnlock(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç›´æ¥HTML Audioã‚’è©¦ã™
        }
    } else {
        preloadVoicesAndUnlock();
    }
}

// documentå…¨ä½“ã§æœ€åˆã®ã‚¿ãƒƒãƒã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰ï¼ˆä»–ã®è¦ç´ ã‚ˆã‚Šå…ˆã«å‡¦ç†ã™ã‚‹ï¼‰
document.addEventListener('touchstart', handleInitialInteraction, true);
document.addEventListener('mousedown', handleInitialInteraction, true);

// --- ãƒ¢ãƒã‚¤ãƒ«éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã¨ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã®çµ‚äº† ---
</script>

<script src="https://cdn.tailwindcss.com"></script>
<style>
        /* ç”»é¢å…¨ä½“ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’åºƒã’ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0;
            overflow: hidden;
            /* --- ã‚²ãƒ¼ãƒ ç”»é¢ã®èƒŒæ™¯ã‚’ background_white.png ã«å¤‰æ›´ --- */
            background-image: url('https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/background_white.png');
            background-size: cover; /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã¨åŒã˜è¡¨ç¤ºæ–¹æ³• */
            background-repeat: no-repeat;
            background-position: center;
        }

        /* æ°´ç‰ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
        :root {
            /* å††ã®ã‚µã‚¤ã‚ºã‚’å°ã•ãã€é’ã„è™¹å½©é¢¨ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€æ˜åº¦é«˜ã‚ */
            --dot-gradient: radial-gradient(circle at center, 
                rgba(240, 250, 255, 0.4) 0%,      /* ä¸­å¿ƒ: éå¸¸ã«æ˜ã‚‹ã„ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ */
                rgba(100, 180, 255, 0.3) 10%,      /* ä¸­é–“: æ˜ã‚‹ã„é’ */
                rgba(0, 50, 150, 0.2) 12%,        /* æ¿ƒã„é’ï¼ˆè™¹å½©ã®ç¸ï¼‰ */
                transparent 15%                  /* å¤–å´: é€æ˜ï¼ˆæ°´ç‰ã®çµ‚ç‚¹ï¼‰ */
            );
        }

        /* æ°´ç‰ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
        .gradient-polka-dots {
            position: fixed;
            inset: 0;
            z-index: 90; /* æœ€å‰é¢ã«é…ç½® */
            display: flex;
            flex-direction: column;
            max-width: min(90vw, 450px); 
            width: 100%; 
            margin: 0 auto;
            justify-content: center;
            align-items: flex-end; 
            position: relative; 
            
            background-color: #FAFEFF; 
            overflow: hidden; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚³ãƒ³ãƒ†ãƒŠå¤–ã«å‡ºã‚‹ã®ã‚’é˜²ã */
            position: absolute; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¾Œã‚ã«é…ç½®ã™ã‚‹ãŸã‚çµ¶å¯¾é…ç½® */
            
            /* 2å±¤ã®èƒŒæ™¯ï¼ˆåƒé³¥é…ç½®ç”¨ï¼‰ */
            background-image: 
                var(--dot-gradient),
                var(--dot-gradient);
            
            /* ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚µã‚¤ã‚ºã¯80px 160pxã§ç¶­æŒ */
            background-size: 80px 160px, 80px 160px; 
            
            /* åˆæœŸä½ç½®: å¥‡æ•°è¡Œ(0 0)ã€å¶æ•°è¡Œ(40px 80px) */
            background-position: 
                0 0, 40px 80px; 
            
            /* flowã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ã‚’é©ç”¨ */
            animation: flow 15s linear infinite;
            
            /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚ˆã‚Šã‚‚ä¸‹ã«è¡¨ç¤º */
            z-index: -1; 
        }

        /* flow: å…¨ã¦ã®æ°´ç‰ã‚’å³ã«æµã™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes flow {
            from { 
                background-position: 0 0, 40px 80px; 
            }
            to {
                background-position: -80px 0, -40px 80px; 
            }
        }


        /* --- ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã®ãµã‚ãµã‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-12px); }
            100% { transform: translateY(0px); }
        }
        #title-image {
            animation: float 3s ease-in-out infinite;
            margin-bottom: -10px;
        }
        
        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #start-screen {
            position: fixed;
            inset: 0;
            z-index: 90; /* æœ€å‰é¢ã«é…ç½® */
            display: flex;
            flex-direction: column;
            align-items: center;
            /* ä¿®æ­£ç‚¹: ä¸Šä¸‹ä¸­å¤®æƒãˆã«æˆ»ã—ã€è¦ç´ ãŒä¸Šä¸‹ã«åã¾ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
            justify-content: center;
            min-height: 100vh; /* ç”»é¢é«˜ã•ã‚ˆã‚Šå°ã•ããªã‚‰ãªã„ã‚ˆã†ã«ä¿è¨¼ */
            
            /* èƒŒæ™¯ç”»åƒã®è¨­å®š */
            background-image: url('https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/background.png');
            
            /* --- ğŸ’¡ ä¿®æ­£: ãƒ¢ãƒã‚¤ãƒ«ç‰ˆï¼ˆç¸¦é•·ï¼‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š --- */
            /* ç”»é¢ã‚’è¦†ã„å°½ãã—ã€æ¨ªã«éš™é–“ãŒã§ããªã„ã‚ˆã†ã«ã™ã‚‹ (ä¸Šä¸‹ã¯åˆ‡ã‚Œã¦ã‚‚OK) */
            background-size: cover;
            
            background-repeat: no-repeat; /* ç¹°ã‚Šè¿”ã—ã‚’é˜²æ­¢ */
            background-position: center;
            
            /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            transition: transform 0.7s ease-in-out;
            
            /* ğŸ’¡ ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®é€éã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®èƒŒæ™¯è‰²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
            background-color: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(2px);
        }

        /* --- ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼ˆæ¨ªé•·ï¼‰ã®è¨­å®š (769pxä»¥ä¸Šã§ä¸Šæ›¸ã) --- */
        @media (min-width: 769px) {
            #start-screen {
                /* PCãªã©æ¨ªé•·ã®ç”»é¢ã§ã¯ã€ç”»åƒå…¨ä½“ã‚’è¡¨ç¤ºã—ã€ä¸Šä¸‹å·¦å³ã«ä½™ç™½ãŒã§ãã‚‹è¨­å®š */
                background-size: contain; 
            }
        }

        #start-button {
            cursor: pointer;
            width: 33%;
            min-width: 150px;
            max-width: 300px;
            transition: transform 0.15s;
            margin-top: -10px; /
        }
        #start-button:hover {
            transform: scale(1.05);
        }
        #start-button:active {
            transform: scale(0.95);
        }

        /* é›¨ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #rainCanvas {
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            position: fixed;
            top: 0;
            left: 0;
            z-index: 40; /* ã‚²ãƒ¼ãƒ UIã®ä¸Šã«é…ç½® */
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸‹ã«é€éã•ã›ã‚‹ */
            opacity: 0.8;
            transition: opacity 1s;
        }
        
        /* ç›¤é¢ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .board-grid {
            width: min(80vmin, 350px); 
            height: min(80vmin, 350px);
            aspect-ratio: 1 / 1; 
            background-color: #73C2FB; /* ç¢ç›¤ã®è‰² */
            border: 4px solid #4CA6E7;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            margin: 0 auto; 
            border-radius: 8px;
            position: relative; 
            --interval: calc(100% / 14); 
            /* ç¢ç›¤ã®ç·šã‚’æç”» */
            background-image: 
                linear-gradient(to right, #F4FBFE 1px, transparent 1px),
                linear-gradient(to bottom, #F4FBFE 1px, transparent 1px),
                radial-gradient(circle at center, #F4FBFE 4px, transparent 5px); 
            background-repeat: repeat, repeat, no-repeat; 
            background-size: var(--interval) var(--interval);
            background-position: 
                0 0, 
                0 0, 
                calc(var(--interval) * 7) calc(var(--interval) * 7); 
        }

        /* çŸ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .cell {
            position: absolute;
            /* 15x15ã®ã‚°ãƒªãƒƒãƒ‰ã®ä¸­å¿ƒã«åˆã‚ã›ã‚‹ãŸã‚ã€å¹…/é«˜ã•ã‚’èª¿æ•´ */
            width: calc(100% / 15); 
            height: calc(100% / 15);
            cursor: pointer;
            z-index: 20;
        }
        .piece {
            position: absolute;
            width: 90%; 
            height: 90%;
            /* ğŸ’¡ ä¿®æ­£: clip-pathã‚’ä½¿ã£ã¦å½¢çŠ¶ã‚’å¼·åˆ¶çš„ã«å††å½¢ã«ã‚¯ãƒªãƒƒãƒ—ã™ã‚‹ */
            clip-path: circle(50%); 
            /* ä¿®æ­£: border-radius: 50%; ãŒbox-shadowã‚’å††å½¢ã«ã™ã‚‹ãŸã‚ã«å¿…è¦ */
            border-radius: 50%; 
            pointer-events: none; 
            /* å½±ã®åˆæœŸå€¤ (è–„ã„å½±) */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4); 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0); 
            animation: placePiece 0.15s forwards; 
            
            /* ç”»åƒèª¿æ•´ */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        @keyframes placePiece {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }
        
        /* ğŸ’¡ æ–°ã—ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®ã‚¯ãƒ©ã‚¹ (ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ–¹å¼) */
        .last-move-highlight {
            position: absolute;
            /* çŸ³ã®å¤§ãã•ã«åˆã‚ã›ã‚‹ */
            width: 90%; 
            height: 90%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            
            pointer-events: none;
            z-index: 30; /* çŸ³(z-index: 20)ã®ä¸Šã«ç½®ã */
            
            /* é€éèµ¤ä¸¸ã®SVGç”»åƒã‚’èƒŒæ™¯ã«è¨­å®š */
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='none' stroke='%23FF4136' stroke-width='10' opacity='0.8'/></svg>");
            background-size: 100%;
            background-repeat: no-repeat;
        }
        
        .winning-piece {
            /* clip-pathã¨border-radius: 50%ã«ã‚ˆã‚Šã€ã“ã®å½±ãŒå††å½¢ã«ãªã‚‹ */
            box-shadow: 0 0 10px 4px gold, 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        #character-and-message {
            max-width: min(90vw, 450px); 
            width: 100%; 
            margin: 0 auto;
            /* ä¿®æ­£æ¸ˆã¿: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é ˜åŸŸã‚’400pxã«æ‹¡å¤§ */
            height: 400px; 
            display: flex; 
            justify-content: center;
            align-items: flex-end; 
            padding-bottom: 0; 
            position: relative; 
        }
        
        /* ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #char-image-container {
            position: relative; 
            /* ä¿®æ­£æ¸ˆã¿: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é ˜åŸŸã‚’400pxã«æ‹¡å¤§ */
            height: 400px; 
            width: auto; 
            display: flex;
            justify-content: flex-start;
            padding-top: 5vh;
            align-items: flex-end;
            overflow: visible; 
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ */
        #char-image {
            width: 100%; 
            /* ä¿®æ­£æ¸ˆã¿: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’400pxã«æ‹¡å¤§ */
            max-height: 400px !important; 
            object-fit: contain; 
            position: relative; 
            z-index: 15;      
            opacity: 1;       
            transition: opacity 0.3s;
            min-width: 100px; 
        }
        
        /* ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã¨è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #audio-control-icon {
            overflow: visible;
            position: relative;
            z-index: 50; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚ˆã‚Šä¸Š */
            cursor: pointer;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }
        
        #audio-control-icon:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        #audio-settings-menu {
            position: absolute;
            top: 0%;
            right: auto;
            left: -200px;
            z-index: 60;
            width: 200px;
            padding: 12px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            flex-direction: column;
            gap: 10px;
        }
        
        #right-icons-container {
        position: absolute; /* ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’çµ¶å¯¾é…ç½®ã§å›ºå®š */
        top: 10px;          
        right: 10px;        
        z-index: 55;        
        
        display: flex;      /* å­è¦ç´ ã‚’ Flexbox ã§é…ç½® */
        flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
        gap: 10px;          /* ã‚¢ã‚¤ã‚³ãƒ³é–“ã®éš™é–“ */
        }
        
        /* ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #link-icon {
        z-index: 50; 
        cursor: pointer;
        padding: 8px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s;
        }
        
        #terushi {
            position:absolute;
            bottom: 180px !important; /* é«˜ã•ã®å›ºå®š */
            
            /* æ¨ªè»¸ã®ä¸­å¤®å¯„ã›ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è¨­å®š */
            left: 0;
            right: 0;
            margin-left: auto;
            margin-right: auto;
  
            transition: transform 3s ease-out, opacity 3s ease-out;
  
            width: 100px !important;
            z-index:25;
            display:none;
            cursor:pointer;
            animation:terushi-float 3s ease-in-out infinite;
          }
          @keyframes terushi-float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-6px);}
            100% { transform: translateY(0); }
          }
          
          /* ãƒ†ãƒ«ã‚·ãƒ¼ç„¡è¦–æ™‚ã®å­˜åœ¨ã‚¢ãƒ”ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (æµ®éŠ + æ‹¡å¤§/ç¸®å°) */
          @keyframes terushi-loss-assert {
              /* 0% (3.0s) ã®ä½ç½®: æµ®éŠ0px, ã‚¹ã‚±ãƒ¼ãƒ«1.0 */
              0% { transform: translateY(0) scale(1.0); } 
              
              /* æµ®éŠãŒã»ã¨ã‚“ã©ãªã„ä½ç½®ã§ã‚¢ãƒ”ãƒ¼ãƒ«é–‹å§‹ (0.25s) */
              8.33% { transform: translateY(-0.5px) scale(1.15); } 
              16.66% { transform: translateY(-1px) scale(1.0); }
              
              /* æµ®éŠä¸­é–“ä½ç½®ã§ã‚¢ãƒ”ãƒ¼ãƒ« (0.75s) */
              25% { transform: translateY(-3px) scale(1.15); }
              33.33% { transform: translateY(-4px) scale(1.0); }
              41.66% { transform: translateY(-5px) scale(1.15); }
              
              /* æµ®éŠæœ€ä¸Šä½ã§ã‚¢ãƒ”ãƒ¼ãƒ« (1.5s) */
              50% { transform: translateY(-6px) scale(1.0); } 
              
              /* æµ®éŠãŒæˆ»ã‚‹é€”ä¸­ã§ã‚¢ãƒ”ãƒ¼ãƒ« (1.75s, 2.0s) */
              58.33% { transform: translateY(-5.5px) scale(1.15); } 
              66.66% { transform: translateY(-5px) scale(1.0); }
              
              /* æµ®éŠä¸­é–“ä½ç½®ã§ã‚¢ãƒ”ãƒ¼ãƒ« (2.25s) */
              75% { transform: translateY(-3px) scale(1.15); }
              83.33% { transform: translateY(-2px) scale(1.0); }
              91.66% { transform: translateY(-1px) scale(1.15); }
              
              /* 100% (3.0s) ã®ä½ç½®ã«æˆ»ã‚‹ */
              100% { transform: translateY(0) scale(1.0); } 
          }

          /* ãƒ†ãƒ«ã‚·ãƒ¼ç„¡è¦–æ™‚ã«é©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹: æ—¢å­˜ã® animation ã‚’ä¸Šæ›¸ãã—ã¦ã€çµ±åˆã—ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ */
          .terushi-loss-assert-active {
              animation: terushi-loss-assert 3s ease-in-out infinite !important;
          }
          
          .terushi-slide-out {
              /* ç¾åœ¨ã®ä½ç½®ã‹ã‚‰å³ã« 2000px ç§»å‹•ã•ã›ã‚‹ */
              transform: translateX(50px) scale(1.0) !important; 
              opacity: 0 !important; /* é€æ˜ã«ã—ã¦å®Œå…¨ã«éè¡¨ç¤ºã«ã™ã‚‹ */
    
              /* è² ã‘æ™‚ã®ã‚¢ãƒ”ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è§£é™¤ã™ã‚‹ãŸã‚ !important ã‚’è¿½åŠ  */
              animation: none !important; 
          }


        /* --- ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ --- */
        @media (max-width: 768px) {
            
            #character-and-message {
                /* ä¿®æ­£æ¸ˆã¿: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é«˜ã•ã‚’220pxã«æ‹¡å¤§ */
                height: auto !important; /* é«˜ã•ã‚’è‡ªå‹•ã«ã—ã€åˆ¶ç´„ã‚’è§£é™¤ */
                bottom: 0 !important;    /* ä¸‹ã‹ã‚‰ã®ä½ç½®æŒ‡å®šã‚’è§£é™¤ */
                max-height: 220px; 
                max-width: 100%; 
                padding: 0 1rem;
                flex-direction: row; 
                align-items: flex-end;
            }
            
            #char-image-container {
                 /* ä¿®æ­£æ¸ˆã¿: ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã‚’220pxã«æ‹¡å¤§ */
                 height: 250px; 
                 width: auto;
            }
            #char-image {
                /* ä¿®æ­£æ¸ˆã¿: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’220pxã«æ‹¡å¤§ */
                max-height: 250px !important; 
                width: auto !important; 
                margin-top: 10px;
            }
            
            #speech-bubble {
                position: absolute !important; 
                width: 80% !important;
                transform: translateX(-50%) !important; 
                margin-top: 0;
                margin-bottom: 0;
                left: 50% !important; 
                bottom: 2px !important; 
            }
            
            /* NEW: ãƒ†ãƒ«ã‚·ãƒ¼ã®ãƒ¢ãƒã‚¤ãƒ«ç‰ˆèª¿æ•´ (å°ã•ãã€ä½ç½®ã‚’ä½ã) */
            #terushi {
                width: 60px !important;  /* ã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ (å…ƒã®100pxã‹ã‚‰60pxã¸) */
                bottom: 120px !important;  /* ä½ç½®ã‚’ä½ãã™ã‚‹ (å…ƒã®180pxã‹ã‚‰80pxã¸) */
            }
                        
            #link-icon {
                top: 40px; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä¸Šéƒ¨ã«é…ç½® */
                 right: 10px; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å³å´ã«é…ç½® */
            z-index: 50; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚ˆã‚Šä¸Š */
            }
        }

        /* --- ä¿®æ­£: ãƒœãƒ¼ãƒ‰ã®ä¸Šã«é‡ã­ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #board-wrapper {
             /* å¿…é ˆ: å­è¦ç´ ã®çµ¶å¯¾é…ç½®ã®åŸºæº–ã¨ã™ã‚‹ */
            position: relative; 
        }

        #reset-button-container {
            /* ç¢ç›¤ã®ä¸Šã«é‡ã­ã‚‹ */
            position: absolute; 
            /* ãƒœãƒ¼ãƒ‰ã®ä¸­å¤®ã«é…ç½® */
            top: 50%; 
            left: 50%;
            /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ä¸­å¤®ã«è£œæ­£ */
            transform: translate(-50%, -50%) scale(1);
            
            width: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ãŸã‚ auto ã®ã¾ã¾ã§ã‚‚è‰¯ã„ */
            max-width: 80vw; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¹…ã®æœ€å¤§80%ã«åºƒã’ã‚‹ */
            min-width: 250px; /* å°ã•ããªã‚Šã™ããªã„ã‚ˆã†ã«æœ€å°å¹…ã‚‚è¨­å®š */
            
            /* ä¿®æ­£: ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šæ¸›ã—ã€ãƒœã‚¿ãƒ³ãŒæ”¹è¡Œã—ãªã„ã‚ˆã†ã«å¹…ã‚’ç‹­ã‚ã‚‹ */
            padding: 20px 30px; 
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            z-index: 60; /* ç¢ç›¤ã‚„é›¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ä¸Šã«é…ç½® */
            pointer-events: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯ã‚¯ãƒªãƒƒã‚¯é€é */
        }
        
        /* ãƒœã‚¿ãƒ³è¡¨ç¤ºæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .show-reset-button {
            opacity: 1 !important;
            transform: translate(-50%, -50%) scale(1) !important;
            pointer-events: auto !important; /* è¡¨ç¤ºã•ã‚ŒãŸã‚‰ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
        }
        
        #gohoubi-image {
            cursor: pointer; /* ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«æŒ‡ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º */
            transition: transform 0.15s; /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        }
        
        #gohoubi-image:active {
            transform: scale(0.98); /* æŠ¼ã—ãŸã¨ãã«å°‘ã—ç¸®ã‚€ */
        }

</style>
<script>
        // YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã®URLå®šæ•°
        const YOUTUBE_URL = 'https://www.youtube.com/@amemiya_chika';
        // ã‚²ãƒ¼ãƒ å®šæ•° 
        const BOARD_SIZE = 15;
        const PLAYER_HUMAN = 1; 
        const PLAYER_AI = 2;    
        const AI_NAME = "ã‚¢ãƒ¡ãƒŸãƒ¤ãƒã‚«"; 
        const TURN_TIME_LIMIT = 10; 
        
        // --- ç–²å¼Šãƒ¢ãƒ¼ãƒ‰è¨­å®š ---
        const FATIGUE_THRESHOLD = 25; // 25æ‰‹ã§ç–²å¼Šãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
        const FATIGUE_ERROR_CHANCE = 0.50; // 50%ã®ç¢ºç‡ã§æœ€å–„æ‰‹ä»¥å¤–ã®æ‰‹ã‚’æ‰“ã¤ 

        // --- å‹åˆ©æ™‚ç”»åƒURLå®šç¾© ---
        const GOHOUBI_A_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/gohoubi_A.png"; // ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰å‰
        const GOHOUBI_B_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/gohoubi_B.png"; // ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ä¸­

        // --- éŸ³å£°é–¢é€£ã®å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const VOICE_BASE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/voice/";
        
        // // --- ã”ã»ã†ã³éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å®šç¾© ---
        const GOHOUBI_A_FILENAME = 'gohoubi-a.mp3';
        const GOHOUBI_B_FILENAME = 'gohoubi-b.mp3';
        
        
        // BGMã®URLã¨éŸ³é‡
        const BGM_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/audio/bgm_game.mp3";
        const BGM_VOLUME_DEFAULT = 0.20; // 20%ã®éŸ³é‡
        let gameBGM = null; // BGMç”¨ã®Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

        // çŸ³ã‚’ç½®ãåŠ¹æœéŸ³ã®è¨­å®š 
        const PIECE_PUT_SE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/audio/SE_pieces_on.mp3";
        const PIECE_PUT_SE_VOLUME_DEFAULT = 0.50; // 50%ã®éŸ³é‡
        
        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åŠ¹æœéŸ³ã®è¨­å®š
        const CRITICAL_SE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/audio/SE_critical.mp3";
        const CRITICALE_VOLUME_DEFAULT = 0.50; // 50%ã®éŸ³é‡
        
        // ãƒ†ãƒ«ã‚·ãƒ¼ç”¨åŠ¹æœéŸ³ã®è¨­å®šã‚’è¿½åŠ  ---
        const TERU_OK_SE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/audio/SE_teru_ok.mp3";
        const TERU_NG_SE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/audio/SE_teru_ng.mp3";
        const TERU_SE_VOLUME_DEFAULT = 0.50; // ãƒ†ãƒ«ã‚·ãƒ¼ã®éŸ³é‡
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®åŠ¹æœéŸ³ã®è¨­å®šã‚’è¿½åŠ 
        const PIKON_SE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/audio/SE_pikon.mp3";
        const PIKON_SE_VOLUME_DEFAULT = 0.50; // 50%ã®éŸ³é‡
        // ------------------------------------

        const VOICE_CHANCE_PUT = 0.30; // çŸ³ã‚’ç½®ã„ãŸæ™‚ã®éŸ³å£°å†ç”Ÿç¢ºç‡ 30%

        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ç”¨ã®éŸ³å£° 
        const START_VOICES = ["title_01_ame.mp3", "title_02_teru.mp3"];
        const START_BUTTON_VOICE = ["start_01.mp3", "start_02.mp3", "start_03.mp3", "start_04.mp3", "start_05.mp3", "start_06.mp3"] ;

        // çŸ³ã‚’ç½®ã„ãŸæ™‚ã®ãƒ©ãƒ³ãƒ€ãƒ éŸ³å£°ãƒªã‚¹ãƒˆ
        const PUT_VOICES = [
            "put_01_ei.mp3",
            "put_02_poti.mp3",
            "put_03_torya.mp3",
            "put_04.mp3",
            "put_05.mp3",
            "put_06.mp3",
            "put_07.mp3",
            "put_08.mp3"
        ];
        
        // ãƒ†ãƒ«ã‚·ãƒ¼ã®éŸ³å£°ãƒªã‚¹ãƒˆã‚’è¿½åŠ  ---
        const TETU_OK_VOICES = [
            "tetu_ok_01.mp3",
            "tetu_ok_02.mp3",
            "tetu_ok_03.mp3",
            "tetu_ok_04.mp3",
            "tetu_ok_05.mp3",
            "tetu_ok_06.mp3",
            "tetu_ok_07.mp3"
        ];
        
        const TETU_NG_VOICES = [
            "tetu_ng_01.mp3",
            "tetu_ng_02.mp3",
            "tetu_ng_03.mp3"
        ];
        
         // ãƒªãƒ¼ãƒã•ã‚ŒãŸéŸ³å£°ãƒªã‚¹ãƒˆã‚’è¿½åŠ  ---
        const SHOCK_VOICES = [
            "shock_01.mp3",
            "shock_02.mp3",
            "shock_03.mp3",
            "shock_04.mp3",
            "shock_05.mp3",
            "shock_06.mp3",
            "shock_07.mp3",
            "shock_08.mp3",
            "shock_09.mp3",
        ];
        
        // ãƒ”ãƒ³ãƒéŸ³å£°ãƒªã‚¹ãƒˆã‚’è¿½åŠ  ---
        const PINCH_VOICES = [
            "pinch_01.mp3",
            "pinch_02.mp3",
            "pinch_03.mp3",
            "pinch_04.mp3",
            "pinch_05.mp3"
        ];
        

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å¯¾å¿œã™ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å
        const MESSAGE_VOICE_MAP = {
            "ã•ã°ãã®ãŠã˜ã‹ã‚“ã§ã—ã‚…": "katikaku_01_sabaki.mp3",
            "å‹åˆ©ã®ç¢ºç‡100ï¼…": "katikaku_02_syouri.mp3",
            "ã“ã®å±•é–‹ã‚’å¾…ã£ã¦ãŸãœãƒ¼ï¼": "katikaku_03_kono.mp3",
            "ãƒªãƒ¼ãƒã‹ã‚‚ï½": "reach_01_kamo.mp3",
            "ãªã‚“ã¨ã‹ãªã‚‹ãªã‚‹ï½": "reach_02_nantoka.mp3",
            "ãã“ã§ã„ã„ã®ã‹ãªãƒ¼": "reach_03_sokode.mp3",
            "ã„ãã¾ã™ã‚ˆãƒ¼ï¼": "reach_04_ikimasu.mp3",
            "ç–²ã‚Œã¦ãã¡ã‚ƒã£ãŸãªã...": "hirou_01_tukare.mp3",
            "ã­ã‚€ã„ï½...": "hirou_02_nemui.mp3",
            "ãŠã‚„ã¤ãŸã¹ãŸã„ã§ã—ã‚…ï½": "hirou_03_oyatu.mp3"
        };

        // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®éŸ³å£°ãƒªã‚¹ãƒˆ
        const WIN_VOICES = ["win_01.mp3", "win_02.mp3", "win_03_jitu.mp3", "win_04_oyasumi.mp3", "win_05_oshimai.mp3", "win_06.mp3", "win_07.mp3", "win_08.mp3", "win_09.mp3", "win_10.mp3", "win_11.mp3"];
        const LOSE_VOICE = ["lose_01.mp3", "lose_02_tekagen.mp3", "lose_03_sontaku.mp3", "lose_04_jinsei.mp3", "lose_05_nipon.mp3", "lose_06_kimiga.mp3", "lose_07_omigoto.mp3", "lose_08.mp3", "lose_09.mp3"];
        const TIMEOUT_VOICES = ["timeup_01_oya.mp3", "timeup_02_tekagen.mp3", "timeup_03_jikandesyu.mp3", "timeup_04_jikandesu.mp3"];
        
        // --- NEW: ãƒªãƒ—ãƒ¬ã‚¤æ™‚ã®éŸ³å£°ãƒªã‚¹ãƒˆã‚’è¿½åŠ  ---
        const REPLAY_VOICES = [
            "replay_01_zeinuki.mp3",
            "replay_02_mou.mp3",
            "replay_03_madamada.mp3",
            "replay_04.mp3",
            "replay_05.mp3"
        ];
        
        // AIã®è©•ä¾¡å€¤
        const SCORE_WEIGHTS = { 0: 0, 1: 1, 2: 10, 3: 10000, 4: 1000000, 5: 10000000 };
        const IMAGE_BASE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/amemiya_";
        
        // --- NEW: ã‚¢ãƒ¡ãƒŸãƒ¤ãƒã‚«ã®ãƒ”ãƒ³ãƒç”»åƒURLå®šç¾©ã®è¿½åŠ  ---
        const PINCH_01_URL = IMAGE_BASE_URL + "pinch01.png"; // æ´»å››ã‚ˆã‚‹å‹ç¢ºæ™‚
        const PINCH_02_URL = IMAGE_BASE_URL + "pinch02.png"; // å˜ä¸€ã®å››é€£ã«ã‚ˆã‚‹ãƒªãƒ¼ãƒæ™‚
        // ------------------------------------
        
        // --- ä¿®æ­£: çŸ³ã®ç”»åƒURLå®šç¾© ---
        const BLACK_STONE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/kuroishi.png";
        const WHITE_STONE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/shiroishi.png";
        
        // ç›¸æ‰‹ã®å‹åˆ©é˜»æ­¢ï¼ˆå³åº§ã®5é€£ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã®ã‚¹ã‚³ã‚¢
        const BLOCK_BONUS = 15000000; 
        // å‹åˆ©ã‚¹ã‚³ã‚¢ (æœ€å„ªå…ˆ: 5é€£ã«ãªã£ãŸå ´åˆ)
        const WIN_SCORE = SCORE_WEIGHTS[5] * 2; // 20,000,000 
        // æ´»å›› (ä¸¡è¾ºç©ºã) ã‚¹ã‚³ã‚¢ - å‹åˆ©ã‚ˆã‚Šå°‘ã—ä½ã„ãŒã€ãƒ–ãƒ­ãƒƒã‚¯ã‚ˆã‚Šé«˜ã„
        const OPEN_FOUR_WIN_SCORE = 19000000; // 19,000,000
        
        // --- ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ ---
        const RANDOM_MESSAGES = {
            // æ´»å››ã‚ˆã‚‹å‹ç¢ºæ™‚
            WIN_CONFIRMED: [
                "ã•ã°ãã®ãŠã˜ã‹ã‚“ã§ã—ã‚…",
                "å‹åˆ©ã®ç¢ºç‡100ï¼…",
                "ã“ã®å±•é–‹ã‚’å¾…ã£ã¦ãŸãœãƒ¼ï¼"
            ],
            // å˜ä¸€ã®å››é€£ã«ã‚ˆã‚‹ãƒªãƒ¼ãƒæ™‚
            REACH: [
                "ãƒªãƒ¼ãƒã‹ã‚‚ï½",
                "ãªã‚“ã¨ã‹ãªã‚‹ãªã‚‹ï½",
                "ãã“ã§ã„ã„ã®ã‹ãªãƒ¼",
                "ã„ãã¾ã™ã‚ˆãƒ¼ï¼"
            ],
            // ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰çªå…¥æ™‚ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
            FATIGUE_START: [
                "ç–²ã‚Œã¦ãã¡ã‚ƒã£ãŸãªã...",
                "ã­ã‚€ã„ï½...",
                "ãŠã‚„ã¤ãŸã¹ãŸã„ã§ã—ã‚…ï½"
            ]
        };

        let aiGuaranteedWin = false;
        let isPlayerGuaranteedWin = false;
        let isPinchThinking = false; 
        let board = [];
        let currentPlayer = PLAYER_HUMAN;
        let gameActive = true;
        // lastMoveã‚’æ­£ç¢ºã«ä¿æŒã™ã‚‹ã“ã¨ã§ã€èµ¤ã„æ ã®è¡¨ç¤ºã‚’å®‰å®šã•ã›ã‚‹
        let lastMove = null; 
        let timerInterval = null;
        let timeRemaining = TURN_TIME_LIMIT;
        let moveCount = 0; // ç¾åœ¨ç›¤é¢ã«ã‚ã‚‹çŸ³ã®ç·æ•°
        
        // --- ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰çªå…¥æ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ãƒ•ãƒ©ã‚° ---
        let hasAnnouncedFatigue = false; 
        // â˜…â˜…â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ 1: ã“ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’è¿½åŠ  â˜…â˜…â˜…
        let fatigueVoicePlayedCount = 0; 

        let statusElement;
        let boardElement;
        let timerElement;
        let thinkingIndicator;
        let charImageElement;
        let speechBubbleElement; 
        // --- ä¿®æ­£: ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‹ã‚‰ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ã¸ ---
        let resetButtonContainerElement; 
        let modalResetButton; 
        let pinchOverlayImageElement;
        
        // â˜…â˜…â˜… NEW: ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢é–¢é€£ã®è¦ç´  â˜…â˜…â˜…
        let startScreenElement;
        let startButtonElement;
        let gameWrapperElement; // #game-wrapper ã®è¦ç´ 
        
        // --- NEW: éŸ³å£°è¨­å®šé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let bgmVolume = BGM_VOLUME_DEFAULT;
        let seVoiceVolume = 0.8; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯0.8

        // --- é›¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        var W = window.innerWidth; 
        var H = window.innerHeight; 
        let rainCanvas;
        let rainCtx;
        let drops = [];
        let rainAnimationId = null;

        // --- é›¨ç²’ã®è¨­å®š ---
        const DROP_COUNT = 80; 
        const DROP_COLOR = 'rgba(70, 90, 110, 0.85)'; 
        const DROP_LENGTH_MIN = 10;
        const DROP_LENGTH_MAX = 20;
        const DROP_SPEED_MIN = 5;
        const DROP_SPEED_MAX = 12;
        
        // GitHubã®LICENSE.md ã® Raw URL
        const LICENSE_URL = "https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/LICENSE.md";
        
        /**
         * å¤–éƒ¨ã® LICENSE.md ãƒ•ã‚¡ã‚¤ãƒ«ã‚’éåŒæœŸã§å–å¾—ã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹
         */
        async function loadLicenseContent() {
            const licenseContentElement = document.getElementById('license-content');
            if (!licenseContentElement) return;
        
            // èª­ã¿è¾¼ã¿ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            licenseContentElement.innerHTML = '<p class="text-center mt-4 text-gray-500">æœ€æ–°ã®åˆ©ç”¨è¦ç´„ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
        
            try {
                const response = await fetch(LICENSE_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // â˜…â˜…â˜… æ–‡å­—åŒ–ã‘å¯¾ç­–ã®ãŸã‚ã®ä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
                // 1. ArrayBufferã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const buffer = await response.arrayBuffer();
                // 2. TextDecoder (UTF-8) ã‚’ä½¿ã£ã¦æ–‡å­—åˆ—ã«å¤‰æ›
                const text = new TextDecoder('shift-jis').decode(buffer);
                // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…
                
                // --- ç°¡æ˜“çš„ãª Markdown ã® HTML å¤‰æ› (è¡¨ç¤ºç”¨) ---
                let htmlContent = text
                    // è¦‹å‡ºã— # ã‚’ <h2> ã«å¤‰æ›
                    .replace(/# (.+)/g, '<h2 class="text-xl font-bold mt-4 mb-2 text-gray-900">$1</h2>')
                    // è¦‹å‡ºã— ## ã‚’ <h3> ã«å¤‰æ›
                    .replace(/## (.+)/g, '<h3 class="text-lg font-semibold mt-3 mb-1 text-gray-800 border-b pb-1">$1</h3>')
                    // **å¤ªå­—** ã‚’ <strong> ã«å¤‰æ›
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    // é€£ç¶šã™ã‚‹æ”¹è¡Œã‚’ <p> ã‚¿ã‚°ã®çµ‚ã‚ã‚Šã¨ã—ã€å˜ä¸€ã®æ”¹è¡Œã‚’ <br> ã¨ã™ã‚‹
                    .replace(/\n\n/g, '</p><p class="mt-2 text-sm">')
                    .replace(/\n/g, '<br>')
                    
                // æœ€åˆã® <p> ã‚¿ã‚°ã‚’æŒ¿å…¥
                htmlContent = '<p class="text-sm">' + htmlContent + '</p>';
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å†…å®¹ã‚’æŒ¿å…¥
                licenseContentElement.innerHTML = htmlContent;
        
            } catch (error) {
                console.error("Failed to fetch license content:", error);
                licenseContentElement.innerHTML = '<p class="text-red-600 text-center mt-4">åˆ©ç”¨è¦ç´„ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
         * @param {string} type - 'WIN_CONFIRMED', 'REACH', 'FATIGUE_START'
         */
        function getRandomMessage(type) {
            const messages = RANDOM_MESSAGES[type];
            if (!messages || messages.length === 0) {
                return `[ERROR: No messages for ${type}]`;
            }
            const randomIndex = Math.floor(Math.random() * messages.length);
            return messages[randomIndex];
        }
        
        // --- éŸ³å£°è¨­å®šã®ãƒ­ãƒ¼ãƒ‰ã¨ä¿å­˜ ---
        function loadAudioSettings() {
            try {
                const storedBgmVolume = localStorage.getItem('bgmVolume');
                const storedSeVoiceVolume = localStorage.getItem('seVoiceVolume');

                // isMutedã®ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’å‰Šé™¤

                if (storedBgmVolume !== null) {
                    bgmVolume = parseFloat(storedBgmVolume);
                    // BGMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚Œã°éŸ³é‡ã‚’é©ç”¨ï¼ˆisMutedã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ï¼‰
                    if (gameBGM) gameBGM.volume = bgmVolume; 
                } else {
            bgmVolume = BGM_VOLUME_DEFAULT;
                }
                if (storedSeVoiceVolume !== null) {
                    seVoiceVolume = parseFloat(storedSeVoiceVolume);
                } else {
                    seVoiceVolume = 0.8;
                }
            } catch (e) {
                console.warn("Could not load audio settings from localStorage:", e);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                bgmVolume = BGM_VOLUME_DEFAULT;
                seVoiceVolume = 0.8;
            }
            // UIã«åæ˜ 
            updateAudioSettingsUI();
        }

        //
        // saveAudioSettings() é–¢æ•°å…¨ä½“
        function saveAudioSettings() {
            try {
                // isMutedã®ä¿å­˜å‡¦ç†ã‚’å‰Šé™¤
                localStorage.setItem('bgmVolume', bgmVolume);
                localStorage.setItem('seVoiceVolume', seVoiceVolume);
            } catch (e) {
                console.warn("Could not save audio settings to localStorage:", e);
            }
        }
        
        function updateAudioSettingsUI() {
            const bgmSlider = document.getElementById('bgm-volume-slider');
            const seVoiceSlider = document.getElementById('se-voice-volume-slider');
            const icon = document.getElementById('audio-icon');
        
            if (bgmSlider) bgmSlider.value = bgmVolume * 100;
            if (seVoiceSlider) seVoiceSlider.value = seVoiceVolume * 100;
        
            // muteButtonã«é–¢ã™ã‚‹å‡¦ç†ã‚’å‰Šé™¤
        
            if (icon) {
                const imageUrl = 'https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/onpu.png';
                // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã® SVG ã‚’ã€æŒ‡å®šã•ã‚ŒãŸéŸ³ç¬¦ç”»åƒã«ç½®ãæ›ãˆã¾ã™ã€‚
                icon.innerHTML = `<img src="${imageUrl}" alt="éŸ³é‡èª¿æ•´" style="display: block; width: 24px; height: 24px;"/>`;
            }
        
            // BGMã®éŸ³é‡ã‚’æ›´æ–°
            if (gameBGM) {
                // isMutedã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
                gameBGM.volume = bgmVolume;
            }
        
            // â˜… ä¿®æ­£ç®‡æ‰€: linkIconã‚’é–¢æ•°å†…ã§å–å¾—ã™ã‚‹ (762è¡Œç›®ä»˜è¿‘)
            const linkIcon = document.getElementById('link-icon'); 
            
            if (linkIcon) {Â 
                const imageUrl = 'https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/move.png';
                // ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã® SVG ã‚’ã€æŒ‡å®šã•ã‚ŒãŸç”»åƒã«ç½®ãæ›ãˆã¾ã™ã€‚
                linkIcon.innerHTML = `<img src="${imageUrl}" alt="youtubeã«ã‚¢ã‚¯ã‚»ã‚¹" style="display: block; width: 24px; height: 24px;"/>`;
            }
        }

        function handleBGMVolumeChange(event) {
            const newVolume = event.target.value / 100;
            bgmVolume = newVolume;
        
            if (gameBGM) {
                 // isMutedã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
                 gameBGM.volume = bgmVolume;

                 // ã€â˜…ä¿®æ­£ç®‡æ‰€â˜…ã€‘
                 if (newVolume > 0 && gameBGM.paused) {
                     // éŸ³é‡ãŒ0ã‚ˆã‚Šå¤§ãããªã‚Šã€ã‹ã¤BGMãŒä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã€å†é–‹ã™ã‚‹
                     // playBGM()ã¯æ›²ã®å…ˆé ­ã«æˆ»ã£ã¦ã—ã¾ã†ãŸã‚ã€play()ã‚’ç›´æ¥ä½¿ç”¨
                     gameBGM.play().catch(e => {
                         console.warn("BGM resume failed:", e.message);
                     });
                 } else if (newVolume === 0 && !gameBGM.paused) {
                     // éŸ³é‡ãŒ0ã«ãªã‚Šã€ã‹ã¤BGMãŒå†ç”Ÿä¸­ã®å ´åˆã€åœæ­¢ã™ã‚‹
                     stopBGM();
                 }
            }

            // isMutedã®æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤
            updateAudioSettingsUI();
            saveAudioSettings();
        }
            
        function handleSEVoiceVolumeChange(event) {
            const newVolume = event.target.value / 100;
            seVoiceVolume = newVolume;
            
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå‹•ã„ãŸå ´åˆã®ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤
    
            updateAudioSettingsUI();
            saveAudioSettings();            
        } // <-- é–¢æ•°ã‚’é–‰ã˜ã‚‹ãŸã‚ã®æ­£ã—ã„é–‰ã˜æ‹¬å¼§ã¯ã“ã“ã ã‘

        // --- éŸ³å£°å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * éŸ³å£°ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å†ç”Ÿã—ã¾ã™ã€‚
         * @param {string|string[]} fileNames - å†ç”Ÿã™ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿã®ãŸã‚ã«é…åˆ—ã‚‚å¯ï¼‰
         * @param {number} probability - å†ç”Ÿç¢ºç‡ (0.0ã‹ã‚‰1.0)
         * @returns {boolean} - éŸ³å£°å†ç”ŸãŒè©¦ã¿ã‚‰ã‚ŒãŸã‹ã©ã†ã‹
         */
        function playVoice(fileNames, probability = 1.0) {
            if (seVoiceVolume === 0) return false;
            
            if (Math.random() > probability) {
                return false; 
            }
            
            if (fileNames === TIMEOUT_VOICES && preloadedTimeoutVoices.length > 0) {
                const randomIndex = Math.floor(Math.random() * preloadedTimeoutVoices.length);
                const voice = preloadedTimeoutVoices[randomIndex];
                
                // æ—¢ã«å†ç”Ÿæ¸ˆã¿ã§ã‚‚é ­ã‹ã‚‰å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«ç¾åœ¨ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                voice.currentTime = 0; 
                voice.volume = seVoiceVolume; // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã•ã‚ŒãŸéŸ³é‡ã‚’é©ç”¨
                
                voice.play().catch(e => {
                     console.error('ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒœã‚¤ã‚¹ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                });
                return true; 
            }
            
            let fileName = Array.isArray(fileNames) 
                           ? fileNames[Math.floor(Math.random() * fileNames.length)] 
                           : fileNames;
            
            const url = VOICE_BASE_URL + fileName;
            
            // æ–°ã—ã„Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦å†ç”Ÿ
            const audioToPlay = new Audio(url);
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã•ã‚ŒãŸéŸ³é‡ã‚’é©ç”¨
            audioToPlay.volume = seVoiceVolume; 
            audioToPlay.play().catch(e => {
                // è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ã«å¼•ã£ã‹ã‹ã£ãŸå ´åˆãªã©ã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
                // console.warn("Audio play failed:", e.message);
            });
            return true;
        }
        
        // â˜…â˜…â˜… NEW: åŠ¹æœéŸ³å†ç”Ÿé–¢æ•° (éŸ³é‡èª¿æ•´é©ç”¨) â˜…â˜…â˜…
        /**
         * åŠ¹æœéŸ³ (SE) ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å†ç”Ÿã—ã¾ã™ã€‚
         * ä»–ã®éŸ³ã¨é‡ãªã£ã¦ã‚‚å†ç”Ÿã•ã‚Œã‚‹ã‚ˆã†ã«ã€æ–°ã—ã„Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
         * @param {string} url - å†ç”Ÿã™ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®URL
         * @param {number} defaultVolume - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®éŸ³é‡ (0.0ã‹ã‚‰1.0)
         */
        function playSE(url, defaultVolume) {
            if (seVoiceVolume === 0) return;
            
            const audioToPlay = new Audio(url);
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã•ã‚ŒãŸéŸ³é‡ã‚’é©ç”¨
            audioToPlay.volume = seVoiceVolume;
            
            audioToPlay.play().catch(e => {
                // è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ã«å¼•ã£ã‹ã‹ã£ãŸå ´åˆãªã©ã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
                // console.warn("SE play failed:", e.message);
            });
            // å†ç”Ÿçµ‚äº†å¾Œã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä»»ã›ã‚‹
        }
        // ---------------------------------
        
        // â˜…â˜…â˜… NEW: ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®éŸ³å£°å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        function playStartScreenVoice() {
            if (seVoiceVolume === 0) return;
            const chance = 0.8;
            
            // 80%ã§ title_01_ame.mp3 ã‚’å†ç”Ÿ (START_VOICES[0])
            const played = playVoice(START_VOICES[0], chance);
            
            // 80%ã®ç¢ºç‡ã§å†ç”Ÿã•ã‚Œãªã‹ã£ãŸå ´åˆ (20%ã®ç¢ºç‡)
            if (!played) {
                // title_02_teru.mp3 ã‚’å†ç”Ÿ (START_VOICES[1])
                playVoice(START_VOICES[1], 1.0); 
            }
        }
        
        // â˜…â˜…â˜… NEW: BGMã®å†ç”Ÿ/å†é–‹/ãƒªã‚»ãƒƒãƒˆé–¢æ•° (éŸ³é‡èª¿æ•´é©ç”¨) â˜…â˜…â˜…
        function playBGM() {
            if (bgmVolume === 0) return;
            
            if (!gameBGM) {
                // BGMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ã“ã“ã§åˆæœŸåŒ–
                gameBGM = new Audio(BGM_URL);
                gameBGM.loop = true; // ãƒ«ãƒ¼ãƒ—å†ç”Ÿã‚’è¨­å®š
            }
            
            // å†ç”Ÿä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å†ç”Ÿ
            gameBGM.currentTime = 0;
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã•ã‚ŒãŸéŸ³é‡ã‚’é©ç”¨
            gameBGM.volume = bgmVolume; 
            
            // play()ã¯éåŒæœŸãªã®ã§ã€Promiseã®catchã§ã‚¨ãƒ©ãƒ¼å‡¦ç†
            gameBGM.play().catch(e => {
                // è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ãªã©ã§å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
                console.warn("BGM play blocked, will try again on user interaction:", e.message);
            });
        }
        
        function stopBGM() {
            if (gameBGM) {
                gameBGM.pause();
                // å†ç”Ÿä½ç½®ã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆä¸€æ™‚åœæ­¢ï¼‰
            }
        }

        let originalImageSrc = null; // å…ƒã®ç”»åƒã®URLã‚’ä¿æŒã™ã‚‹
        let pinchTimeoutId = null; // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ãŸã‚ã®ID
        
        /**
         * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç”»åƒã‚’ä¸€æ™‚çš„ã«åˆ‡ã‚Šæ›¿ãˆã€2ç§’å¾Œã«å…ƒã«æˆ»ã™
         * @param {string} imageUrl - åˆ‡ã‚Šæ›¿ãˆã‚‹æ–°ã—ã„ç”»åƒã®URL
         */
        function displayPinchImage(imageUrl) {
            if (!charImageElement) return;
        
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢ã—ã€å‰ã®ç”»åƒã‚’ã™ãã«å…ƒã«æˆ»ã™
            if (pinchTimeoutId) {
                clearTimeout(pinchTimeoutId);
                if (originalImageSrc) {
                    charImageElement.src = originalImageSrc;
                }
            }
        
            // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã‚’å…ƒã®ç”»åƒã¨ã—ã¦ä¿å­˜
            // æ—¢ã«ãƒ”ãƒ³ãƒç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€å…ƒã®ç”»åƒãŒ originalImageSrc ã«æ®‹ã£ã¦ã„ã‚‹ã¯ãš
            if (originalImageSrc === null) {
                originalImageSrc = charImageElement.src;
            }
            
            // æ–°ã—ã„ç”»åƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹
            charImageElement.src = imageUrl;
        
            // 2ç§’å¾Œã«ç”»åƒã‚’å…ƒã«æˆ»ã™ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
            pinchTimeoutId = setTimeout(() => {
                if (charImageElement && originalImageSrc) {
                    charImageElement.src = originalImageSrc;
                }
                originalImageSrc = null; // ãƒªã‚»ãƒƒãƒˆ
                pinchTimeoutId = null; // ãƒªã‚»ãƒƒãƒˆ
            }, 2000); // 2ç§’
        }

        // â˜…â˜…â˜… NEW: ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        function startGame() {
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€2: ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®åŠ¹æœéŸ³å†ç”Ÿã‚’è¿½åŠ  â˜…â˜…â˜…
            playSE(PIKON_SE_URL, PIKON_SE_VOLUME_DEFAULT); 
            
            // 1. ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³éŸ³å£°å†ç”Ÿ
            playVoice(START_BUTTON_VOICE, 1.0);
            
            // 2. BGMå†ç”Ÿé–‹å§‹
            playBGM();

            // 3. ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            // start-screen ã‚’ç”»é¢å¤–ï¼ˆä¸Šï¼‰ã«ç§»å‹•ã•ã›ã‚‹
            startScreenElement.style.transform = 'translateY(-100vh)';
    
            // 4. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚²ãƒ¼ãƒ é–‹å§‹ (0.7ç§’å¾Œ)
            // gameWrapperElement.classList.add('active-game'); // ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤
        
            setTimeout(() => {
                // start-screen ã‚’DOMã‹ã‚‰å‰Šé™¤ã™ã‚‹ã‹ã€display:noneã«ã™ã‚‹
                startScreenElement.style.display = 'none';
                
                // 5. ã‚²ãƒ¼ãƒ æœ¬ä½“ã®åˆæœŸåŒ–
                initializeGame();
                
                // 6. éŸ³å£°è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('audio-control-icon').style.display = 'block';
            }, 700); 
        }
        
        // --- NEW: éŸ³å£°è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ« ---
        function toggleAudioSettingsMenu() {
            const menu = document.getElementById('audio-settings-menu');
            if (menu.style.display === 'flex') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'flex';
                // è¡¨ç¤ºæ™‚ã«æœ€æ–°ã®UIè¨­å®šã‚’åæ˜ 
                updateAudioSettingsUI();
            }
        }
        
        /**
         * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé»’ï¼‰ã®ç¢ºå®šãƒªãƒ¼ãƒçŠ¶æ…‹ã«å¿œã˜ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã‚’æ›´æ–°ã™ã‚‹ã€‚
         */
        function updatePinchOverlay() {
        
            const pinchOverlayImageElement = document.getElementById('pinch-overlay-image');
            const charImageElement = document.getElementById('char-image');
            
            // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‡¦ç†ã‚’çµ‚äº†
            if (!pinchOverlayImageElement || !charImageElement) return;
            
            if (!charImageElement) return;
        
            if (isPlayerGuaranteedWin) {
                // ãƒ•ãƒ©ã‚°ãŒã‚ªãƒ³ãªã‚‰è¡¨ç¤º
                
                // char-imageã‚’éè¡¨ç¤ºã«ã™ã‚‹
                charImageElement.style.visibility = 'hidden'; //;

                // pinchOverlayImageElementã‚’è¡¨ç¤ºã«ã™ã‚‹
                pinchOverlayImageElement.style.display = 'block';
                pinchOverlayImageElement.src = PINCH_01_URL; 
            } else {
                // ãƒ•ãƒ©ã‚°ãŒã‚ªãƒ•ãªã‚‰éè¡¨ç¤º
                // char-imageã‚’è¡¨ç¤ºã«æˆ»ã™
                charImageElement.style.visibility = 'visible';
        
                // pinchOverlayImageElementã‚’éè¡¨ç¤ºã«ã™ã‚‹
                pinchOverlayImageElement.style.display = 'none';
            }
        }


        /**
         * æŒ‡å®šæ™‚é–“ï¼ˆ2ç§’ï¼‰å¾Œã«ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
         * NOTE: renderGame() ã¨ handleTimeOut() ã®ä¸¡æ–¹ã§åˆ©ç”¨ã™ã‚‹ãŸã‚é–¢æ•°åŒ–
         */
        function showResetButton() {
            if (resetButtonContainerElement) {
                resetButtonContainerElement.style.display = 'block'; 
                resetButtonContainerElement.classList.add('show-reset-button'); 
            }
        }
        
        /**
         * ç›¤é¢ã®åˆæœŸåŒ–ã¨UIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
         */
        document.addEventListener('DOMContentLoaded', () => {
            speechBubbleElement = document.getElementById('speech-bubble'); 
            statusElement = document.getElementById('status-text');
            timerElement = document.getElementById('timer');
            thinkingIndicator = document.getElementById('thinking-indicator'); 
            charImageElement = document.getElementById('char-image'); 
            pinchOverlayImageElement = document.getElementById('pinch-overlay-image');
            boardElement = document.getElementById('board');
            rainCanvas = document.getElementById('rainCanvas');
            rainCtx = rainCanvas.getContext('2d');
            
            // --- ä¿®æ­£: ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ã®å–å¾—ã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
            resetButtonContainerElement = document.getElementById('reset-button-container'); 
            modalResetButton = document.getElementById('modal-reset-button');
            
            // --- NEW: ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢è¦ç´ ã®å–å¾—ã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
            startScreenElement = document.getElementById('start-screen');
            startButtonElement = document.getElementById('start-button');
            gameWrapperElement = document.getElementById('game-wrapper'); // æ–°è¦ãƒ©ãƒƒãƒ‘ãƒ¼
            const titleImageElement = document.getElementById('title-image');
            
            // --- NEW: éŸ³å£°è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼è¦ç´ ã®å–å¾—ã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
            document.getElementById('audio-control-icon').addEventListener('click', toggleAudioSettingsMenu);
            document.getElementById('bgm-volume-slider').addEventListener('input', handleBGMVolumeChange);
            document.getElementById('se-voice-volume-slider').addEventListener('input', handleSEVoiceVolumeChange);
            
            const audioSettingsMenu = document.getElementById('audio-settings-menu');
            if (audioSettingsMenu) {
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã§ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã«ä¼æ’­ã™ã‚‹ã®ã‚’é˜²ã
                audioSettingsMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // èµ·å‹•æ™‚ã«éŸ³é‡è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
            loadAudioSettings();

            startButtonElement.addEventListener('click', startGame);
            titleImageElement.addEventListener('click', playStartScreenVoice);

            window.addEventListener('resize', () => {
                if (rainAnimationId !== null) {
                    initRain();
                }
            });

            initializeBoardUI();
            
            // ğŸ’¡ ä¿®æ­£: initializeGame() ã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤ã—ã€startGame()ã«ä»»ã›ã‚‹
            // initializeGame(); 
            
            // ãƒœã‚¿ãƒ³ã«ãƒªã‚»ãƒƒãƒˆå‹•ä½œã‚’è¨­å®š
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€3: ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®åŠ¹æœéŸ³å†ç”Ÿã‚’è¿½åŠ  â˜…â˜…â˜…
            modalResetButton.addEventListener('click', () => {
                playSE(PIKON_SE_URL, PIKON_SE_VOLUME_DEFAULT); // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®åŠ¹æœéŸ³
                playBGM(); // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã¯BGMã‚’æœ€åˆã‹ã‚‰å†ç”Ÿ
                initializeGame();
            });
            
            // YouTubeãƒªãƒ³ã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚’è¿½åŠ  ---
            const linkIconElement = document.getElementById('link-icon');
            if (linkIconElement) {
                linkIconElement.addEventListener('click', openYouTubeLink);
            }
            
            const openButton = document.getElementById('open-license-modal');
            const closeButton = document.getElementById('close-license-modal');
            const modal = document.getElementById('license-modal');

            if (openButton && modal && closeButton) {
                // åˆ©ç”¨è¦ç´„ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€è¦ç´„ã‚’èª­ã¿è¾¼ã‚€
                openButton.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    loadLicenseContent(); // æœ€æ–°ã®è¦ç´„ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ã‚’å‘¼ã³å‡ºã—
                    modal.style.display = 'flex'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                });
               
                // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeButton.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
               
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
            
        });
        
        // --- é›¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
        class Raindrop {
            constructor() {
                this.reposition();
                this.y = Math.random() * H; 
            }

            reposition() {
                W = window.innerWidth; 
                H = window.innerHeight; 
                this.x = Math.random() * W;
                this.y = -20 - (Math.random() * 300);
                this.length = Math.random() * (DROP_LENGTH_MAX - DROP_LENGTH_MIN) + DROP_LENGTH_MIN;
                this.speed = Math.random() * (DROP_SPEED_MAX - DROP_SPEED_MIN) + DROP_SPEED_MIN;
                this.opacity = Math.random() * 0.5 + 0.2; 
            }

            fall() {
                this.y += this.speed;
                if (this.y > H) {
                    this.reposition();
                }
            }

            draw() {
                rainCtx.beginPath();
                rainCtx.strokeStyle = DROP_COLOR.replace('0.7', this.opacity.toFixed(2));
                rainCtx.lineWidth = 1.5;
                rainCtx.lineCap = 'round';
                rainCtx.moveTo(this.x, this.y);
                rainCtx.lineTo(this.x, this.y + this.length);
                rainCtx.stroke();
            }
        }

        function initRain() {
            W = window.innerWidth;
            H = window.innerHeight;
            rainCanvas.width = W;
            rainCanvas.height = H;
            
            drops = [];
            for (let i = 0; i < DROP_COUNT; i++) {
                drops.push(new Raindrop());
                drops[i].y = Math.random() * H; 
            }
        }

        function animateRain() {
            rainCtx.clearRect(0, 0, W, H);
            
            for (let i = 0; i < drops.length; i++) {
                drops[i].fall();
                drops[i].draw();
            }
            
            if (rainAnimationId !== null) {
                rainAnimationId = requestAnimationFrame(animateRain);
            }
        }

        function startRain() {
            if (rainAnimationId === null) {
                initRain(); 
                rainCanvas.style.display = 'block';
                rainAnimationId = requestAnimationFrame(animateRain);
            }
        }

        function stopRain() {
            if (rainAnimationId !== null) {
                cancelAnimationFrame(rainAnimationId);
                rainAnimationId = null;
                rainCanvas.style.display = 'none';
            }
        }

        /**
         * å‹åˆ©æ™‚ã«ã€ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³æ•°ã«å¿œã˜ã¦å ±é…¬ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹
         */
        function displayWinImage() {
            if (!resetButtonContainerElement) return; // ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
        
            // å‹åˆ©æ™‚ã®åˆè¨ˆæ‰‹æ•°ã‚’å–å¾—
            const totalMoveCount = moveCount;
        
            // é»’ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ãŒç½®ã„ãŸæ‰‹æ•°ã‚’è¨ˆç®—
            const blackPlayerMoves = Math.ceil(totalMoveCount / 2);
        
            // â˜… ä¿®æ­£ç‚¹1: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã«å‹åˆ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ â˜…
            if (typeof timerElement !== 'undefined' && timerElement) {
                // timerElement ã®å†…å®¹ã‚’å‹åˆ©æ‰‹æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä¸Šæ›¸ã
                // ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã€ã”æç¤ºã®startTimer()ã§ã®timerElementå†…ã®spanã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆtext-lg font-extraboldï¼‰ã«åˆã‚ã›ã¾ã™
                timerElement.innerHTML = `${blackPlayerMoves} æ‰‹ã§å‹åˆ©`;
            } 
        
            // â˜… ä¿®æ­£ç‚¹2: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ï¼ˆspeechBubbleElementï¼‰ã®èƒŒæ™¯è‰²ã‚’å‹åˆ©ç”¨ã«å¤‰æ›´
            if (typeof speechBubbleElement !== 'undefined' && speechBubbleElement) {
                 // ã‚¿ã‚¤ãƒãƒ¼æ™‚ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                 speechBubbleElement.classList.remove('bg-blue-500', 'shadow-blue-500/80', 'bg-red-400', 'bg-red-500', 'bg-red-600', 'shadow-red-400/80', 'shadow-red-500/80', 'shadow-red-600/80', 'animate-pulse');
                 // å‹åˆ©å°‚ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ  (ä¾‹: æ´¾æ‰‹ãªç·‘)
                 speechBubbleElement.classList.add('bg-green-500', 'shadow-green-500/80');
            }
        
            
            // ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š: totalMoveCount ãŒ FATIGUE_THRESHOLD ä»¥ä¸Šã‹
            const isFatigueWin = totalMoveCount > FATIGUE_THRESHOLD;
            const imageUrl = isFatigueWin ? GOHOUBI_B_URL : GOHOUBI_A_URL;
            const altText = isFatigueWin ? "ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã”ã»ã†ã³ç”»åƒ" : "é€šå¸¸æ™‚ã®ã”ã»ã†ã³ç”»åƒ";
        
            // æ—¢å­˜ã®ç”»åƒã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ  (ãƒªã‚»ãƒƒãƒˆ/å†æˆ¦æ™‚ã®ãŸã‚ã«)
            const existingImage = document.getElementById('gohoubi-image');
            if (existingImage) {
                existingImage.remove();
            }
            
            // â˜… ä¿®æ­£ç‚¹3: ä»¥å‰ã®è³ªå•ã§è¿½åŠ ã—ãŸã‚¹ã‚³ã‚¢è¡¨ç¤ºè¦ç´ ã‚’ç¢ºå®Ÿã«å‰Šé™¤ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«å‡ºãªã„ã‚ˆã†ã«ï¼‰
            const existingScore = document.getElementById('win-score-display');
            if (existingScore) {
                existingScore.remove();
            }
        
            // 1. ã”ã»ã†ã³ç”»åƒè¦ç´ ã‚’ä½œæˆ
            const imageElement = document.createElement('img');
            imageElement.id = 'gohoubi-image';
            imageElement.src = imageUrl;
            imageElement.alt = altText;
            imageElement.classList.add('w-full', 'max-w-lg', 'mx-auto', 'mb-4'); 
            imageElement.style.maxWidth = '80vw'; 
            imageElement.style.width = '100%';
        
            // ã€Œã‚‚ã†ä¸€å›ã€ãƒœã‚¿ãƒ³ã®è¦ç´ ã‚’å–å¾—
            const resetButton = document.getElementById('modal-reset-button');
        
            // å‹åˆ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ã«ç”»åƒã‚’è¿½åŠ 
            if (resetButton) {
                // ãƒœã‚¿ãƒ³ã®ç›´å‰ã«ç”»åƒã‚’æŒ¿å…¥
                resetButtonContainerElement.insertBefore(imageElement, resetButton);
            } else {
                // ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã‚³ãƒ³ãƒ†ãƒŠã®æœ«å°¾ã«è¿½åŠ 
                resetButtonContainerElement.appendChild(imageElement);
            }
            imageElement.addEventListener('click', () => {
                // ç–²å¼Šãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                // GOHOUBI_A_FILENAME, GOHOUBI_B_FILENAME ãŒå®šæ•°ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                const voiceFilename = isFatigueWin ? GOHOUBI_B_FILENAME : GOHOUBI_A_FILENAME;

                // VOICE_BASE_URL ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                const voiceUrl = VOICE_BASE_URL + voiceFilename;

                // playSE é–¢æ•°ã§éŸ³å£°ã‚’å†ç”Ÿ
                // ãƒœãƒªãƒ¥ãƒ¼ãƒ å®šæ•°ãŒãªã„ãŸã‚ã€ã“ã“ã§ã¯ 1.0 (æœ€å¤§) ã‚’æŒ‡å®šã—ã¾ã™ã€‚
                playSE(voiceUrl, 1.0); 
            });
        }
        
        /**
         * YouTubeãƒªãƒ³ã‚¯ã‚’é–‹ã
         */
        function openYouTubeLink() {
            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¾ãŸã¯ã‚¿ãƒ–ã§URLã‚’é–‹ã
            window.open(YOUTUBE_URL, '_blank');
        }
 
 
        // --- ã‚²ãƒ¼ãƒ æœ¬ä½“ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        /**
         * ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’åˆæœŸåŒ–
         */
        function initializeGame() {
            // â˜…â˜…â˜… NEW: ãƒªãƒ—ãƒ¬ã‚¤éŸ³å£°ã®å†ç”Ÿã‚’è¿½åŠ  â˜…â˜…â˜…
            // ãŸã ã—ã€åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã‚„ã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å¾Œã«ã—ã‹ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ã‚’è€ƒæ…®ã—ã€
            // ç›¤é¢ã«çŸ³ãŒä¸€ã¤ã‚‚ç½®ã‹ã‚Œã¦ã„ãªã„çŠ¶æ…‹ï¼ˆmoveCount === 0ï¼‰ã§ãªã‘ã‚Œã°å†ç”Ÿã™ã‚‹ã€‚
            // (åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãšã«é–‹ç™ºè€…ãŒç›´æ¥initializeGameã‚’å‘¼ã‚“ã å ´åˆã€moveCountã¯0ã®ã¾ã¾)
            if (moveCount > 0) { 
                playVoice(REPLAY_VOICES, 1.0); // 100%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ
            }            
            
            // --- NEW: å‹åˆ©æ™‚ç”»åƒã‚’ã‚¯ãƒªã‚¢ ---
            const existingImage = document.getElementById('gohoubi-image');
            if (existingImage) {
                existingImage.remove();
            }
            // --------------------------------
            
            board = Array(BOARD_SIZE).fill(0).map(() => Array(BOARD_SIZE).fill(0));
            currentPlayer = PLAYER_HUMAN;
            gameActive = true;
            lastMove = null;
            moveCount = 0;
            hasAnnouncedFatigue = false; 
            // â˜…â˜…â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ 2: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…
            fatigueVoicePlayedCount = 0; 
            
            clearInterval(timerInterval);
            timeRemaining = TURN_TIME_LIMIT;
            
            if (timerElement) {
                timerElement.innerHTML = `æŒã¡æ™‚é–“: <span class="text-lg font-extrabold">${TURN_TIME_LIMIT}</span> ç§’`;
            }
            
            if (thinkingIndicator) thinkingIndicator.textContent = ""; 
            
            stopRain(); 
            setCharacterMood('normal', 'normal'); // â˜…ä¿®æ­£: moodTypeã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
            updateStatus(`å¯¾å±€é–‹å§‹ï¼ã‚ãªãŸï¼ˆé»’ï¼‰ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`, 'normal'); // updateStatusã‚’å‘¼ã³å‡ºã—
            
            // --- NEW: éŸ³å£°è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã« ---
            const audioSettingsMenu = document.getElementById('audio-settings-menu');
            if (audioSettingsMenu) audioSettingsMenu.style.display = 'none';


            // --- ä¿®æ­£: ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤ºã«æˆ»ã™ ---
            if (resetButtonContainerElement) {
                resetButtonContainerElement.classList.remove('show-reset-button'); 
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«é…å»¶ã•ã›ã¦ã‹ã‚‰display: none
                setTimeout(() => { resetButtonContainerElement.style.display = 'none'; }, 300); 
            }
            
        // â˜…â˜…â˜… NEW: ã‚²ãƒ¼ãƒ UIã‚’è¡¨ç¤ºã•ã›ã‚‹ â˜…â˜…â˜…
        // if (gameWrapperElement) {
        //     gameWrapperElement.style.visibility = 'visible';
        // }
            
            renderGame();
        }
        
        /**
         * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¡¨æƒ…ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
         * @param {string} mood - 'normal', 'win', 'loss', 'thinking', 'smile', 'reach', 'tired'
         * @param {string} moodType - 'normal', 'win_confirmed', 'reach', 'tired' ãªã©ã®ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ³ã‚’ç¤ºã™ã‚¿ã‚¤ãƒ—
         */
        function setCharacterMood(mood, moodType = 'normal') {
            if (!charImageElement) return;

            let suffix = 'normal.png'; 

            if (mood === 'win') {
                suffix = 'win.png'; 
            } else if (mood === 'loss') {
                suffix = 'lose.png'; 
            } else if (mood === 'thinking') {
                suffix = 'think.png'; 
            } else if (mood === 'smile') {
                suffix = 'smile.png'; 
            } else if (mood === 'reach') {
                // â˜…â˜…â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ãƒªãƒ¼ãƒã®ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ â˜…â˜…â˜…
                if (moodType === 'win_confirmed') {
                    // å‹ç¢ºã«ã¤ãªãŒã‚‹ãƒªãƒ¼ãƒ (æ´»å››ãªã©)
                    suffix = 'reach01.png'; 
                } else if (moodType === 'reach') {
                    // å˜ãªã‚‹ãƒªãƒ¼ãƒ (å››é€£ãªã©)
                    suffix = 'reach02.png'; // æ–°ã—ã„ç”»åƒ
                } else {
                    suffix = 'reach01.png'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯reach01
                }
            } else if (mood === 'tired') { 
                suffix = 'tired.png'; 
            }
            
            const path = IMAGE_BASE_URL + suffix;
            
            charImageElement.onerror = () => {
                charImageElement.src = 'https://placehold.co/160x160/cccccc/333333?text=Char';
            };
            
            charImageElement.src = path;
        }
        
        // ----------------------------------------------------
        // â˜…â˜…â˜… NEW: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è„…å¨åº¦ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ  â˜…â˜…â˜…
        // ----------------------------------------------------
        
        /**
         * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (é»’) ã®ç€æ‰‹ã«ã‚ˆã£ã¦ç”Ÿã˜ãŸè„…å¨åº¦ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
         * (æ´»å››ã€ã¾ãŸã¯å˜ä¸€ã®å››é€£ã‚’æ¤œå‡º)
         * @param {number} r - ç€æ‰‹ã—ãŸè¡Œ
         * @param {number} c - ç€æ‰‹ã—ãŸåˆ—
         * @returns {'WIN_CONFIRMED'|'REACH'|'NONE'} - æ´»å››ã€å››é€£ãƒªãƒ¼ãƒã€ã¾ãŸã¯è„…å¨ãªã—
         */
        function checkHumanThreats(r, c) {
            const player = PLAYER_HUMAN;
            const directions = [
                [0, 1],  // æ°´å¹³
                [1, 0],  // å‚ç›´
                [1, 1],  // å³ä¸‹ãŒã‚Šæ–œã‚
                [1, -1]  // å·¦ä¸‹ãŒã‚Šæ–œã‚
            ];
        
            let hasLiveFour = false; // æ´»å››ï¼ˆä¸¡ç«¯ç©ºãï¼‰
            let hasFourInARow = false; // å˜ä¸€ã®å››é€£ï¼ˆç‰‡ç«¯ã¾ãŸã¯ä¸¡ç«¯ç©ºãï¼‰
        
            for (const [dr, dc] of directions) {
                let count = 1;
                let openEnds = 0; 
                
                // 1. æ­£ã®æ–¹å‘
                for (let i = 1; i <= 4; i++) {
                    const nr = r + dr * i;
                    const nc = c + dc * i;
                    if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === player) {
                        count++;
                    } else {
                        if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === 0) {
                            openEnds++;
                        }
                        break;
                    }
                }
                
                // 2. è² ã®æ–¹å‘
                for (let i = 1; i <= 4; i++) {
                    const nr = r - dr * i;
                    const nc = c - dc * i;
                    if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === player) {
                        count++;
                    } else {
                        if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === 0) {
                            openEnds++;
                        }
                        break;
                    }
                }
                
                if (count === 4) {
                    // å››é€£ãŒæˆç«‹
                    if (openEnds === 2) {
                        hasLiveFour = true; // æ´»å››ï¼ˆå‹ç¢ºï¼‰
                    }
                    if (openEnds >= 1) {
                        hasFourInARow = true; // ãƒªãƒ¼ãƒï¼ˆç‰‡ç«¯ã¾ãŸã¯ä¸¡ç«¯ç©ºãï¼‰
                    }
                }
            }
        
            if (hasLiveFour) {
                return 'WIN_CONFIRMED';
            } else if (hasFourInARow) {
                return 'REACH';
            }
            
            return 'NONE';
        }
        
        
        function checkBoardForLiveFour(player) {
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] === 0) { // ç©ºããƒã‚¹ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
                        
                        // 1. ãã®ãƒã‚¹ã«çŸ³ã‚’ä»®ç½®ãã—ã¦ã¿ã‚‹
                        board[r][c] = player; 
                        
                        // 2. å³å¯†ãª checkWinï¼ˆ5é€£åˆ¤å®šï¼‰ã§å‹åˆ©ã™ã‚‹ã‹åˆ¤å®š
                        if (checkWin(r, c, player)) {
                            
                            // 3. ç›¤é¢ã‚’å…ƒã«æˆ»ã™
                            board[r][c] = 0; 
                            return true; // å‹åˆ©ç¢ºå®šã®æ‰‹ãŒå­˜åœ¨ã™ã‚‹
                        }
                        
                        // 3. ç›¤é¢ã‚’å…ƒã«æˆ»ã™
                        board[r][c] = 0; 
                    }
                }
            }
            return false;
        }
        
        function checkBoardForLiveFour_StrictLiveFour(player) {
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]
            ];
        
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] === 0) {
                        
                        board[r][c] = player; 
                        
                        for (const [dr, dc] of directions) {
                            const result = countConsecutive(r, c, dr, dc, player);
                            
                            // å³å¯†ãªä¸¡æ´»å››ã®æ¡ä»¶: 5é€£ã«ãªã‚‹ && ä¸¡ç«¯ãŒç©ºã„ã¦ã„ã‚‹ (openEnds >= 2)
                            if (result.count >= 5 && result.openEnds >= 2) {
                                board[r][c] = 0;
                                return true; 
                            }
                        }
                        
                        board[r][c] = 0; 
                    }
                }
            }
            return false;
        }
        
        function initializeBoardUI() {
            if (!boardElement) return;
            boardElement.innerHTML = '';
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    // ç›¤é¢ã®äº¤ç‚¹ã«ã‚»ãƒ«ã‚’é…ç½®
                    const interval = 100 / (BOARD_SIZE - 1);
                    const leftPos = c * interval; 
                    const topPos = r * interval;
                    
                    cell.style.left = `${leftPos}%`;
                    cell.style.top = `${topPos}%`;
                    cell.style.transform = 'translate(-50%, -50%)'; 
                    
                    cell.addEventListener('click', () => handleCellClick(r, c));
                    boardElement.appendChild(cell);
                }
            }
        }
        
        function renderGame() {
            if (!boardElement || !timerElement || !thinkingIndicator) return;

            const cells = boardElement.querySelectorAll('.cell');
            cells.forEach(cell => {
                const r = parseInt(cell.dataset.row);
                const c = parseInt(cell.dataset.col);
                const player = board[r][c];

                cell.innerHTML = ''; 
                
                if (player !== 0) {
                    const piece = document.createElement('div');
                    piece.classList.add('piece');
                    
                    // --- ä¿®æ­£: ç”»åƒã‚’é©ç”¨ ---
                    if (player === PLAYER_HUMAN) {
                        piece.style.backgroundImage = `url('${BLACK_STONE_URL}')`;
                    } else {
                        piece.style.backgroundImage = `url('${WHITE_STONE_URL}')`;
                    }
                    piece.style.backgroundColor = 'transparent'; // èƒŒæ™¯è‰²ã¯é€æ˜ã«
                    
                    // ğŸ’¡ ä¿®æ­£: ã“ã“ã§pieceã‚’è¿½åŠ 
                    cell.appendChild(piece);
                    
                    // --- ğŸ’¡ æ–°è¦è¿½åŠ : æœ€å¾Œã«ç½®ã„ãŸçŸ³ã®ä¸Šã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é‡ã­ã‚‹ ---
                    if (lastMove && lastMove.r === r && lastMove.c === c) {
                        const highlight = document.createElement('div');
                        highlight.classList.add('last-move-highlight');
                        // piece(z:20)ã‚ˆã‚Šã‚‚ä¸Šã«é…ç½®ã•ã‚Œã‚‹(z:30)
                        cell.appendChild(highlight); 
                    }
                    // ----------------------------------------------------
                }
            });

            if (!gameActive) { // â˜…ä¿®æ­£: ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®šã‚’çµ±åˆ
                // å‹åˆ©ç·šãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (lastMove) {
                    const winningCoords = findWinningLine(lastMove.r, lastMove.c, lastMove.player);
                    if (winningCoords) {
                        highlightWinningLine(winningCoords);
                    }
                }
                
            } else if (gameActive) {
                // ã‚²ãƒ¼ãƒ ä¸­ã¯ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
                if (resetButtonContainerElement) {
                    resetButtonContainerElement.classList.remove('show-reset-button'); 
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«é…å»¶ã•ã›ã¦ã‹ã‚‰display: none
                    setTimeout(() => { resetButtonContainerElement.style.display = 'none'; }, 300); 
                }

                clearInterval(timerInterval);
                if (currentPlayer === PLAYER_HUMAN) {
                    // äººé–“ã®ã‚¿ãƒ¼ãƒ³ã§ã¯æ€è€ƒä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’éè¡¨ç¤º
                    thinkingIndicator.textContent = ""; 
                    thinkingIndicator.style.display = 'none'; 
                    timerElement.style.display = 'block';
                    if (moveCount > 0) { 
                        startTimer();
                    } else {
                        timerElement.innerHTML = "æœ€åˆã®1æ‰‹ã¯æ™‚é–“ç„¡åˆ¶é™ã§ã™";
                    }
                } else {
                    // ä¿®æ­£: AIã‚¿ãƒ¼ãƒ³æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€æ€è€ƒä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    timerElement.style.display = 'none'; 
                    thinkingIndicator.style.display = 'block'; 
                    // AIã®æ€è€ƒé–‹å§‹
                    setTimeout(() => { if (gameActive) aiTurn(); }, 500); 
                }
            }
        }

        function highlightWinningLine(coords) {
            coords.forEach(([r, c]) => {
                const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
                if (cell) {
                    cell.querySelector('.piece')?.classList.add('winning-piece');
                }
            });
        }

        function findWinningLine(r, c, player) {
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]
            ];
            
            for (const [dr, dc] of directions) {
                let line = [];
                let maxCount = 0;
                let winningStones = [];

                for (let i = -4; i <= 4; i++) {
                    const nr = r + i * dr;
                    const nc = c + i * dc;

                    if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE) {
                        if (board[nr][nc] === player) {
                            line.push([nr, nc]);
                        } else {
                            if (line.length > maxCount) {
                                maxCount = line.length;
                                winningStones = [...line];
                            }
                            line = [];
                        }
                    } else {
                         if (line.length > maxCount) {
                            maxCount = line.length;
                            winningStones = [...line];
                        }
                        line = [];
                    }
                }
                if (line.length > maxCount) {
                    maxCount = line.length;
                    winningStones = [...line];
                }

                if (maxCount >= 5) {
                    return winningStones.slice(0, 5);
                }
            }
            return null;
        }

        
        function startTimer() {
            if (!timerElement || !speechBubbleElement) return;

            timeRemaining = TURN_TIME_LIMIT;
            
            const statusDiv = speechBubbleElement;
            statusDiv.classList.remove('bg-red-400', 'bg-red-500', 'bg-red-600', 'shadow-red-400/80', 'shadow-red-500/80', 'shadow-red-600/80', 'animate-pulse');
            statusDiv.classList.add('bg-blue-500', 'shadow-blue-500/80'); 

            // äººé–“ã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤º
            timerElement.innerHTML = `æ®‹ã‚Šæ™‚é–“: <span class="text-lg font-extrabold">${timeRemaining}</span> ç§’`;
            // renderGameã§è¡¨ç¤ºåˆ¶å¾¡ã—ã¦ã„ã‚‹ã®ã§ã“ã“ã§ã¯ä¸è¦
            // timerElement.style.display = 'block'; 

            timerInterval = setInterval(() => {
                timeRemaining--;
                
                timerElement.innerHTML = `æ®‹ã‚Šæ™‚é–“: <span class="text-lg font-extrabold">${timeRemaining}</span> ç§’`;

                statusDiv.classList.remove('bg-red-400', 'bg-red-500', 'bg-red-600', 'shadow-red-400/80', 'shadow-red-500/80', 'shadow-red-600/80', 'animate-pulse');
                statusDiv.classList.remove('bg-blue-500', 'shadow-blue-500/80'); 

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeOut();
                } else if (timeRemaining <= 3) {
                    if (timeRemaining === 3) {
                        statusDiv.classList.add('bg-red-400', 'shadow-red-400/80');
                    } else if (timeRemaining === 2) {
                        statusDiv.classList.add('bg-red-500', 'shadow-red-500/80');
                    } else if (timeRemaining === 1) {
                        statusDiv.classList.add('bg-red-600', 'shadow-red-600/80', 'animate-pulse');
                    }
                } else {
                     statusDiv.classList.add('bg-blue-500', 'shadow-blue-500/80'); 
                }
            }, 1000);
        }

        function handleTimeOut() {
            gameActive = false;
            isPlayerGuaranteedWin = false;
            updatePinchOverlay();
            clearInterval(timerInterval); // â˜…ä¿®æ­£: æ™‚é–“åˆ‡ã‚Œãªã®ã§ã‚¿ã‚¤ãƒãƒ¼ã‚‚åœæ­¢
            stopRain();
            // â˜…â˜…â˜… ä¿®æ­£: ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«BGMã‚’åœæ­¢ â˜…â˜…â˜…
            stopBGM(); 
            if (thinkingIndicator) thinkingIndicator.textContent = ""; 
            updateStatus(`ã€æ™‚é–“åˆ‡ã‚Œã€‘10ç§’ä»¥å†…ã«çŸ³ã‚’ç½®ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚${AI_NAME}ã®å‹ã¡ã§ã™ï¼`, 'loss'); 
            
            // ğŸ’¡ è¿½åŠ : æ™‚é–“åˆ‡ã‚Œã®ãƒ©ãƒ³ãƒ€ãƒ éŸ³å£°å†ç”Ÿ
            playVoice(TIMEOUT_VOICES); 

            renderGame(); 
            
            // --- NEW: 2ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º ---
            setTimeout(showResetButton, 2000); 
        }

        function handleCellClick(r, c) {
            if (!gameActive || currentPlayer !== PLAYER_HUMAN) return;
            if (board[r][c] !== 0) return;
            
            if (thinkingIndicator) thinkingIndicator.textContent = "";

            clearInterval(timerInterval);
            placePiece(r, c, PLAYER_HUMAN, null); 
        }

        async function placePiece(r, c, player, threatType = null) {
            if (board[r][c] !== 0) {
                console.error(`Error: Tried to place piece at occupied cell (${r}, c).`);
                gameActive = false;
                updateStatus(`ã€ã‚¨ãƒ©ãƒ¼ã€‘ç„¡åŠ¹ãªå ´æ‰€ã¸ã®ç€æ‰‹ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚`, 'draw');
                // --- NEW: 2ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º ---
                setTimeout(showResetButton, 2000); 
                return;
            }
            
Â  Â  Â  Â  Â  Â  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé»’ï¼‰ãŒçŸ³ã‚’ç½®ã„ãŸå ´åˆã®ã¿ã€è„…å¨ãƒ¬ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—SEã‚’åˆ†å²
Â  Â  Â  Â  Â  Â  if (player === PLAYER_HUMAN) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé»’ï¼‰ã®ç€æ‰‹æ™‚

                // 1. çŸ³ã‚’ç½®ãå‰ã«ã€ä¸€æ—¦ç©ºããƒã‚¹ã¨ã—ã¦å‡¦ç†
                // 2. checkThreateningLine(r, c, player) ã‚’å‘¼ã³å‡ºã™ã¨ã€
                //    å†…éƒ¨ã§ board[r][c] = player; -> åˆ¤å®š -> board[r][c] = 0; ãŒè¡Œã‚ã‚Œã‚‹ã€‚
                let isCritical = checkThreateningLine(r, c, player);

                // 3. checkThreateningLine ãŒçŸ³ã‚’å…ƒã«æˆ»ã—ã¦ã—ã¾ã†ãŸã‚ã€ã“ã“ã§çŸ³ã‚’ç½®ãç›´ã™ã€‚
                board[r][c] = player; 

                // 4. æ´»å››ã«ã‚ˆã‚‹å³åº§ã®å‹åˆ©ã‚‚ãƒªãƒ¼ãƒã¨è¦‹ãªã™
                if (isCritical || checkWin(r, c, player)) {
                    playSE(CRITICAL_SE_URL, PIECE_PUT_SE_VOLUME_DEFAULT);
                } else {
                    playSE(PIECE_PUT_SE_URL, PIECE_PUT_SE_VOLUME_DEFAULT);
                }
            } else {
                // AIï¼ˆç™½ï¼‰ã®ç€æ‰‹æ™‚
                playSE(PIECE_PUT_SE_URL, PIECE_PUT_SE_VOLUME_DEFAULT);
                board[r][c] = player; // AIã®ç€æ‰‹ã¯ã“ã“ã§ç¢ºå®š
            }
            // ------------------------------------
            lastMove = { r, c, player };
            
            moveCount++; 
            
            if (thinkingIndicator) thinkingIndicator.textContent = ""; 

            if (checkWin(r, c, player)) {
                gameActive = false;
                isPlayerGuaranteedWin = false;
                updatePinchOverlay();
                stopRain(); 
                // â˜…â˜…â˜… ä¿®æ­£: ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«BGMã‚’åœæ­¢ â˜…â˜…â˜…
                stopBGM(); 
                const winnerText = player === PLAYER_HUMAN ? `ã‚ãªãŸ` : `${AI_NAME}`; 
                const statusType = player === PLAYER_HUMAN ? 'win' : 'loss';
                updateStatus(`${winnerText}ã®å‹ã¡ã§ã™ï¼`, statusType);
                
                // ğŸ’¡ è¿½åŠ : å‹åˆ©è€…ã«å¿œã˜ãŸéŸ³å£°å†ç”Ÿ
                if (player === PLAYER_AI) {
                    playVoice(WIN_VOICES); // AIãŒå‹ã£ãŸæ™‚
                } else {
                    playVoice(LOSE_VOICE); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹ã£ãŸæ™‚
                    displayWinImage();
                }

                renderGame(); 
                // --- NEW: 2ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º ---
                setTimeout(() => { //
                    renderGame(); // å‹åˆ©ç·šãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãŸã‚ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° //
                    showResetButton(); //
                }, 2000);

            } else if (isDraw()) {
                gameActive = false;
                isPlayerGuaranteedWin = false;
                updatePinchOverlay();
                stopRain(); 
                // â˜…â˜…â˜… ä¿®æ­£: ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«BGMã‚’åœæ­¢ â˜…â˜…â˜…
                stopBGM(); 
                updateStatus(`ã€å¼•ãåˆ†ã‘ã€‘ç¢ç›¤ãŒã™ã¹ã¦åŸ‹ã¾ã‚Šã¾ã—ãŸã€‚`, 'draw');
                renderGame(); 
                // --- NEW: 2ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º ---
                setTimeout(showResetButton, 2000); 
            } else {
                await switchTurn(threatType);
            }
        }

        async function switchTurn(threatType = null) {
            currentPlayer = currentPlayer === PLAYER_HUMAN ? PLAYER_AI : PLAYER_HUMAN;
            renderGame();
            
            const turnText = currentPlayer === PLAYER_HUMAN ? `ã‚ãªãŸï¼ˆé»’ï¼‰` : `${AI_NAME}ï¼ˆç™½ï¼‰`; 
            
            let message = `${turnText}ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`;
            
            // ä¿®æ­£: moveCount > FATIGUE_THRESHOLD ã«ä¿®æ­£ï¼ˆçŸ³ãŒ25å€‹ä»¥ä¸Šãªã‚‰ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ï¼‰
            const isFatigued = moveCount >= FATIGUE_THRESHOLD; 
            let statusType = isFatigued ? 'tired' : 'normal'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚¤ãƒ—

            if (gameActive) {
                if (isFatigued) {
                    startRain(); 
                    
                    // â†“â†“â†“ ä¿®æ­£ãŒå¿…è¦ãªãƒ–ãƒ­ãƒƒã‚¯: hasAnnouncedFatigueã®ãƒã‚§ãƒƒã‚¯ã¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®åˆ©ç”¨ â†“â†“â†“
                    if (!hasAnnouncedFatigue && fatigueVoicePlayedCount === 0) { // â˜…ä¿®æ­£ç‚¹1: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚‚ãƒã‚§ãƒƒã‚¯
                        setCharacterMood('tired', 'tired'); // â˜…ä¿®æ­£: moodTypeã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
                        const fatigueMsg = getRandomMessage('FATIGUE_START');
                        message = fatigueMsg;
                        statusType = 'tired';
                        
                        // ğŸ’¡ è¿½åŠ : ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰çªå…¥æ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å¯¾å¿œã™ã‚‹éŸ³å£°å†ç”Ÿ
                        playVoice(MESSAGE_VOICE_MAP[fatigueMsg], 1.0); 

                        // â˜…â˜…â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ 3: å†ç”Ÿã—ãŸã®ã§ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’1ã«è¨­å®š â˜…â˜…â˜…
                        fatigueVoicePlayedCount = 1; // â˜…ä¿®æ­£ç‚¹2: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ

                        await new Promise(resolve => setTimeout(resolve, 1500));
                        hasAnnouncedFatigue = true;
                        
                        // ã‚¢ãƒŠã‚¦ãƒ³ã‚¹å¾Œã€æ”¹ã‚ã¦ã‚¿ãƒ¼ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æˆ»ã‚‹
                        message = `${turnText}ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`;
                        
                        // ç¢ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åæ˜ ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è¡¨æƒ…ã¯ç¶­æŒï¼‰
                        updateStatus(message, 'tired'); 
            
                        // â˜…ä¿®æ­£ç‚¹3: ã“ã®returnã¯å‰Šé™¤ã—ãªã„
                        return;
                    } else if (hasAnnouncedFatigue) { // â˜…ä¿®æ­£ç‚¹4: æ—¢ã«ã‚¢ãƒŠã‚¦ãƒ³ã‚¹æ¸ˆã¿ã§ã€ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ã„ã‚‹å ´åˆ
                    
                        // ãƒªãƒ¼ãƒ/å‹ç¢ºã®è„…å¨ãŒç›´å‰ã«ç™ºç”Ÿã—ãŸå ´åˆã€AIã‚¿ãƒ¼ãƒ³ã«ç§»ã‚‹å‰ã«'reach'ã‚’å„ªå…ˆ
                        if (threatType === 'reach' || threatType === 'win_confirmed') {
                             // statusType ã¯ãã®ã¾ã¾ threatType ã«ä¸Šæ›¸ã
                             statusType = threatType;
                             // setCharacterMood ã®å‘¼ã³å‡ºã—ã¯ updateStatus ã«ä»»ã›ã‚‹
                        } else {
                            // ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ä¸­ã€è„…å¨ãŒãªã„å ´åˆã¯ 'tired' ã«å›ºå®š
                            // setCharacterMood ã®å‘¼ã³å‡ºã—ã¯ updateStatus ã«ä»»ã›ã‚‹
                        }
                    }
                    // â†‘â†‘â†‘ ä¿®æ­£ãŒå¿…è¦ãªãƒ–ãƒ­ãƒƒã‚¯ ã“ã“ã¾ã§ â†‘â†‘â†‘
                    
                } else {
                    // éç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã€ç›´å‰ã«è„…å¨ãŒã‚ã£ãŸå ´åˆã¯è¡¨æƒ…ã‚’ç¶­æŒ
                    if (threatType === 'reach' || threatType === 'win_confirmed') {
                        statusType = threatType;
                        // setCharacterMood ã®å‘¼ã³å‡ºã—ã¯ updateStatus ã«ä»»ã›ã‚‹
                    }
                }
            } else {
                // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã¯ä½•ã‚‚ã—ãªã„
            }
            
            // â˜… ä¿®æ­£: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€updateStatusã‚’å‘¼ã³å‡ºã™
            updateStatus(message, statusType);


            // thinkingIndicator ã®è¡¨ç¤ºåˆ¶å¾¡ã¯ renderGame ã«ä»»ã›ã‚‹
            // statusElement.style.display ã¯ updateStatus ã«ä»»ã›ã‚‹
        }
        
        /**
         * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°
         * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {string} type - 'normal', 'win', 'loss', 'draw', 'win_confirmed', 'reach', 'tired'
         */
        function updateStatus(message, type = 'normal') {
            if (!statusElement || !speechBubbleElement) return; 
            
            statusElement.textContent = message;
            
            const statusDiv = speechBubbleElement;
            statusDiv.className = 'absolute z-20 md:w-80 w-[90%] p-3 rounded-xl shadow-2xl transition-colors duration-300 left-1/2 -translate-x-1/2 bottom-2 text-white';
            
            statusDiv.classList.add('p-3');
            statusElement.style.display = 'block';

            // â˜… ä¿®æ­£: ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨æƒ…ã¨è‰²ã‚’æ›´æ–° â˜…
            if (type === 'win') { 
                statusDiv.classList.add('bg-green-500', 'shadow-green-500/80'); 
                setCharacterMood('loss', type); // ç›¸æ‰‹ï¼ˆAIï¼‰ã®æ•—åŒ—è¡¨æƒ…
            } else if (type === 'loss') { 
                statusDiv.classList.add('bg-red-500', 'shadow-red-500/80');
                setCharacterMood('win', type); // ç›¸æ‰‹ï¼ˆAIï¼‰ã®å‹åˆ©è¡¨æƒ…
                stopRain(); 
            } else if (type === 'draw') {
                statusDiv.classList.remove('text-white');
                statusDiv.classList.add('bg-yellow-400', 'text-gray-800', 'shadow-yellow-400/80');
                setCharacterMood('normal', type);
                stopRain(); 
            } else if (type === 'win_confirmed') { 
                statusDiv.classList.add('bg-red-700', 'shadow-red-700/80');
                setCharacterMood('reach', type); // â˜…ä¿®æ­£: win_confirmedã®è¡¨æƒ…ï¼ˆreach01ï¼‰
            } else if (type === 'reach') {
                statusDiv.classList.add('bg-pink-600', 'shadow-pink-600/80');
                setCharacterMood('reach', type); // â˜…ä¿®æ­£: reachã®è¡¨æƒ…ï¼ˆreach02ï¼‰
            } else if (type === 'tired') {
                 statusDiv.classList.add('bg-gray-700', 'shadow-gray-700/80');
                 setCharacterMood('tired', type);
            } else {
                // normal
                statusDiv.classList.add('bg-blue-500', 'shadow-blue-500/80');
                setCharacterMood('normal', type);
            }
        }
        

        function checkWin(r, c, player) {
            // å‹åˆ©åˆ¤å®šã«å¿…è¦ãª4æ–¹å‘ã‚’å®šç¾©
            const directions = [
                [0, 1],   // æ°´å¹³
                [1, 0],   // å‚ç›´
                [1, 1],   // å³ä¸‹ãŒã‚Šæ–œã‚
                [1, -1]   // å·¦ä¸‹ãŒã‚Šæ–œã‚
            ];
        
            for (const [dr, dc] of directions) {
                // countConsecutive ã‚’å‘¼ã³å‡ºã—ã€ç€æ‰‹ç‚¹ (r, c) ã‚’å«ã‚€åˆè¨ˆã®ä¸¦ã³ã®æ•°ã‚’å–å¾—
                const result = countConsecutive(r, c, dr, dc, player);
                
                // â˜…â˜…â˜… å³å¯†ã« 5ã¤ä»¥ä¸Šä¸¦ã‚“ã§ã„ã‚‹ã‹ã‚’ç¢ºèª â˜…â˜…â˜…
                if (result.count >= 5) { 
                    return true; // 5é€£ä»¥ä¸Šã§å‹åˆ©
                }
            }
            return false; // å‹åˆ©ãªã—
        }

        function countConsecutive(r, c, dr, dc, player) {
            let count = 0;
            let openEnds = 0;
            let blocked = 0;
            const opponent = 3 - player;

            let currentR = r + dr;
            let currentC = c + dc;
            while (currentR >= 0 && currentR < BOARD_SIZE && currentC >= 0 && currentC < BOARD_SIZE && board[currentR][currentC] === player) {
                count++;
                currentR += dr;
                currentC += dc;
            }

            if (currentR >= 0 && currentR < BOARD_SIZE && currentC >= 0 && currentC < BOARD_SIZE && board[currentR][currentC] === 0) {
                openEnds++;
            } else if (currentR < 0 || currentR >= BOARD_SIZE || currentC < 0 || currentC >= BOARD_SIZE || board[currentR][currentC] === opponent) {
                blocked++;
            }

            currentR = r - dr;
            currentC = c - dc;
            while (currentR >= 0 && currentR < BOARD_SIZE && currentC >= 0 && currentC < BOARD_SIZE && board[currentR][currentC] === player) {
                count++;
                currentR -= dr;
                currentC -= dc;
            }

            if (currentR >= 0 && currentR < BOARD_SIZE && currentC >= 0 && currentC < BOARD_SIZE && board[currentR][currentC] === 0) {
                openEnds++;
            } else if (currentR < 0 || currentR >= BOARD_SIZE || currentC < 0 || currentC >= BOARD_SIZE || board[currentR][currentC] === opponent) {
                blocked++;
            }
            
            return { count: count + 1, openEnds, blocked: blocked > 0 };
        }

        function getLineScore(r, c, dr, dc, player) {
            const result = countConsecutive(r, c, dr, dc, player);
            
            if (result.count >= 5) {
                return WIN_SCORE;
            }
            
            if (result.count === 4) {
                if (result.openEnds === 2) {
                    return OPEN_FOUR_WIN_SCORE; 
                }
                if (result.openEnds >= 1) {
                    return SCORE_WEIGHTS[4]; 
                }
            }
            
            if (result.count === 3) {
                if (result.openEnds === 2) {
                    return SCORE_WEIGHTS[3]; 
                }
                if (result.openEnds === 1) {
                    return SCORE_WEIGHTS[2]; 
                }
            }

            if (result.count === 2 && result.openEnds === 2) {
                return SCORE_WEIGHTS[1];
            }
            
            if (result.blocked || result.openEnds === 0) {
                return 0;
            }

            return 0;
        }
        
        function checkOpenFour(r, c, player) {
            board[r][c] = player; 
            
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]
            ];
            
            for (const [dr, dc] of directions) {
                const result = countConsecutive(r, c, dr, dc, player);
                
                if (result.count === 4 && result.openEnds === 2) {
                    board[r][c] = 0; 
                    return true;
                }
            }
            
            board[r][c] = 0; 
            return false;
        }
        
        
        // ç›¤é¢å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ç‰¹å®šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ´»å››ãŒã‚ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹
        function checkThreatsAcrossBoard(player) {
            const opponent = 3 - player;
            // ç›¤é¢å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŸ³ãŒç½®ã‹ã‚Œã¦ã„ãªã„ãƒã‚¹ï¼ˆç©ºããƒã‚¹ï¼‰ãŒå¯¾è±¡
                    if (board[r][c] === 0) {
                        // ãã®ãƒã‚¹ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŸ³ã‚’ä»®ç½®ãã—ã¦ã¿ã‚‹
                        board[r][c] = player;
                        
                        // æ´»å›› (WIN_CONFIRMED) ãŒæˆç«‹ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (checkOpenFour(r, c, player)) {
                            board[r][c] = 0; // ä»®ç½®ãã—ãŸçŸ³ã‚’å…ƒã«æˆ»ã™
                            return 'WIN_CONFIRMED';
                        }
                        
                        board[r][c] = 0; // ä»®ç½®ãã—ãŸçŸ³ã‚’å…ƒã«æˆ»ã™
                    }
                }
            }
            return 'NONE'; // æ´»å››ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ
        }
        
        
        function checkDoubleOpenThree(r, c, player) {
            board[r][c] = player; 
            
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]
            ];
            let openThreeCount = 0;
            
            for (const [dr, dc] of directions) {
                const result = countConsecutive(r, c, dr, dc, player);
                
                if (result.count === 3 && result.openEnds === 2) {
                    openThreeCount++;
                }
            }
            
            board[r][c] = 0; 

            return openThreeCount >= 2;
        }


        function checkThreateningLine(r, c, player) {
            board[r][c] = player; 
            const directions = [ [0, 1], [1, 0], [1, 1], [1, -1] ];
            const opponent = 3 - player;

            for (const [dr, dc] of directions) {
                for (let i = -4; i <= 0; i++) {
                    let p_count = 0;      
                    let empty_count = 0;  
                    let opponent_found = false; 

                    for (let j = 0; j < 5; j++) {
                        const cr = r + (i + j) * dr;
                        const cc = c + (i + j) * dc;

                        if (cr < 0 || cr >= BOARD_SIZE || cc < 0 || cc >= BOARD_SIZE) {
                            opponent_found = true;
                            break;
                        }
                        
                        const piece = board[cr][cc];
                        if (piece === player) {
                            p_count++;
                        } else if (piece === 0) {
                            empty_count++;
                        } else if (piece === opponent) {
                            opponent_found = true;
                            break; 
                        }
                    }

                    if (p_count === 4 && empty_count === 1 && !opponent_found) {
                        board[r][c] = 0; 
                        return true;
                    }
                }
            }

            board[r][c] = 0; 
            return false;
        }
        
        function getAvailableMoves() {
            const moves = [];
            const checkRange = 3; 
            
            const occupied = [];
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] !== 0) {
                        occupied.push({ r, c });
                    }
                }
            }

            const candidateCoords = new Set();
            
            if (occupied.length === 0) {
                const centerR = Math.floor(BOARD_SIZE / 2);
                const centerC = Math.floor(BOARD_SIZE / 2);
                for (let r = centerR - 1; r <= centerR + 1; r++) {
                    for (let c = centerC - 1; c <= centerC + 1; c++) {
                        if (r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE) {
                            moves.push({r, c});
                        }
                    }
                }
                return moves.length > 0 ? moves : [{r: centerR, c: centerC}];
            } else {
                occupied.forEach(({ r, c }) => {
                    for (let dr = -checkRange; dr <= checkRange; dr++) {
                        for (let dc = -checkRange; dc <= checkRange; dc++) {
                            const newR = r + dr;
                            const newC = c + dc;
                            
                            if (newR >= 0 && newR < BOARD_SIZE && newC >= 0 && newC < BOARD_SIZE && board[newR][newC] === 0) {
                                candidateCoords.add(`${newR},${newC}`);
                            }
                        }
                    }
                });
            }

            candidateCoords.forEach(coordStr => {
                const [r, c] = coordStr.split(',').map(Number);
                moves.push({ r, c });
            });

            if (moves.length === 0 && moveCount < BOARD_SIZE * BOARD_SIZE) {
                for (let r = 0; r < BOARD_SIZE; r++) {
                    for (let c = 0; c < BOARD_SIZE; c++) {
                        if (board[r][c] === 0) {
                            moves.push({ r, c });
                            return moves; 
                        }
                    }
                }
            }

            return moves;
        }
        
        function findBestMove(player) {
            const opponent = 3 - player;
            const availableMoves = getAvailableMoves();
            const scoredMoves = [];

            if (availableMoves.length === 0) {
                return [];
            }
            
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1] 
            ];

            for (const move of availableMoves) {
                const { r, c } = move;
                let score = 0;
                
                board[r][c] = player;
                if (checkWin(r, c, player)) {
                    board[r][c] = 0;
                    return [{ move: {r, c}, score: WIN_SCORE }]; 
                }
                board[r][c] = 0; 

                board[r][c] = opponent; 
                if (checkWin(r, c, opponent)) {
                    board[r][c] = 0; 
                    score += BLOCK_BONUS; 
                }
                board[r][c] = 0; 
                
                board[r][c] = player; 
                let defenseScore = 0;
                board[r][c] = opponent; 
                for (const [dr, dc] of directions) {
                    const opponentLineScore = getLineScore(r, c, dr, dc, opponent);
                    defenseScore = Math.max(defenseScore, opponentLineScore);
                }
                board[r][c] = 0;
                
                score += defenseScore * 2; 
                
                board[r][c] = player;
                let selfScore = 0;
                for (const [dr, dc] of directions) {
                    selfScore += getLineScore(r, c, dr, dc, player);
                }
                
                board[r][c] = 0;
                
                score += selfScore;

                const center = Math.floor(BOARD_SIZE / 2);
                const distance = Math.max(Math.abs(r - center), Math.abs(c - center));
                score += (BOARD_SIZE - distance) * 5; 

                scoredMoves.push({ move: { r, c }, score });
            }

            scoredMoves.sort((a, b) => b.score - a.score);

            return scoredMoves;
        }

        async function aiTurn() {Â 
            
            // â˜…â˜…â˜… NEW: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ã®ç¢ºå®šãƒªãƒ¼ãƒï¼ˆæ´»å››ï¼‰ã‚’åˆ¤å®šã—ã€ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
    
            // 1. ç›¤é¢å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€å‹åˆ©ç¢ºå®šã®æ‰‹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  const isCurrentlyWinThreat = checkBoardForLiveFour(PLAYER_HUMAN); // å˜å››ã‚‚ true ã«ãªã‚‹
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. ã€æ–°è¦åˆ¤å®šã€‘å³å¯†ãªä¸¡æ´»å››ï¼ˆä¸¡ç«¯ç©ºã4é€£ï¼‰ãŒç›¤é¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  //    â€» checkBoardForLiveFour(player) ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ openEnds >= 2 ã§æ›¸ãæ›ãˆãŸé–¢æ•°ã‚’åˆ¥é€”å®šç¾©ã—ã¦ãã ã•ã„
Â  Â  Â  Â  Â  Â  const isCurrentlyLiveFour = checkBoardForLiveFour_StrictLiveFour(PLAYER_HUMAN); // ä¸¡æ´»å››ã®ã¿ true ã«ãªã‚‹

Â  Â  Â  Â  Â  Â  // â˜…â˜…â˜… ä¿®æ­£ãƒ­ã‚¸ãƒƒã‚¯: ãƒ”ãƒ³ãƒçŠ¶æ…‹ã®ãƒ•ãƒ©ã‚°è¨­å®š â˜…â˜…â˜…
            // ã€Œç¾åœ¨ã€ä¸¡æ´»å››ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ OR ã€ŒAIãŒãƒ–ãƒ­ãƒƒã‚¯ã—ãã‚Œãªã‹ã£ãŸå ´åˆã€ã« true ã‚’ç¶­æŒã™ã‚‹
Â  Â  Â  Â  Â  Â  if (isCurrentlyLiveFour) {
                // å³å¯†ãªæ´»å››ï¼ˆä¸¡æ´»å››ï¼‰ãŒå­˜åœ¨ã™ã‚Œã°ã€ç¢ºå®šãƒªãƒ¼ãƒ
Â  Â  Â  Â  Â  Â  Â  Â  isPlayerGuaranteedWin = true;
Â  Â  Â  Â  Â  Â  } else if (isPlayerGuaranteedWin && isCurrentlyWinThreat) {
                // ä»¥å‰ç¢ºå®šãƒªãƒ¼ãƒã§ã€ã‹ã¤ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã‚‚å˜å››ï¼ˆæ¬¡ã®æ‰‹ã§å‹ã¡ï¼‰ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯ç¶­æŒï¼ˆå˜å››ã‚’æ´»å››ã¨è¦‹ãªã™ï¼‰
                // â€» ã“ã“ã‚’ true ã«ã™ã‚‹ã¨å˜å››ã§ã‚‚ãƒ”ãƒ³ãƒç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹åŸå› ã«ãªã‚‹ãŸã‚ã€
                // å³å¯†ã«ä¸¡æ´»å››ã®ã¿ã‚’ãƒ”ãƒ³ãƒå¯¾è±¡ã¨ã—ãŸã„å ´åˆã¯ã“ã® 'else if' ã¯å‰Šé™¤ã—ã¾ã™ã€‚
                
                // â¡ è¦æœ›ã‚’æº€ãŸã™ãŸã‚ã€å˜å››ã¯ãƒ”ãƒ³ãƒã«å«ã‚ãšã€ä¸¡æ´»å››ï¼ˆçœŸã®æ´»å››ï¼‰ã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¾ã™ã€‚
                
                // æ´»å››ãŒå®Œå…¨ã«è§£æ¶ˆã•ã‚ŒãŸå ´åˆã¯ false
Â  Â  Â  Â  Â  Â  Â  Â  isPlayerGuaranteedWin = false; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  isPlayerGuaranteedWin = false;
Â  Â  Â  Â  Â  Â  }
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã‚’æ›´æ–°
            updatePinchOverlay();
            
Â  Â  Â  Â  Â  Â  if (!gameActive) { if (thinkingIndicator) thinkingIndicator.textContent = ""; return; }Â 

Â  Â  Â  Â  Â  Â  if (thinkingIndicator) thinkingIndicator.textContent = "æ€è€ƒä¸­...";Â 
            
            //isPinchThinking = isPlayerGuaranteedWin;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãšã€æ€è€ƒä¸­ã¯ 'thinking' ã«ã™ã‚‹
            if (!isPinchThinking && !isPlayerGuaranteedWin) { // â˜… ä¿®æ­£ç‚¹2: ç¢ºå®šãƒªãƒ¼ãƒãƒ•ãƒ©ã‚°ã‚‚ãƒã‚§ãƒƒã‚¯ã«è¿½åŠ  â˜…
                 setCharacterMood('thinking', 'thinking'); // moodTypeã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
            }

Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 500));Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // AIãŒæ€è€ƒã‚’çµ‚ãˆãŸã‚‰ã€ãƒ”ãƒ³ãƒæ€è€ƒãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
Â  Â  Â  Â  Â  Â  isPinchThinking = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!gameActive) { if (thinkingIndicator) thinkingIndicator.textContent = ""; return; }Â 

Â  Â  Â  Â  Â  Â  const scoredMoves = findBestMove(PLAYER_AI);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (scoredMoves.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (thinkingIndicator) thinkingIndicator.textContent = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â await switchTurn(null);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â 
            // ----------------------------------------------------
            // â˜…â˜…â˜… ä¿®æ­£ãƒ»çµ±åˆã—ãŸãƒ­ã‚¸ãƒƒã‚¯ (finalMoveã®æ±ºå®š) â˜…â˜…â˜…
            // ----------------------------------------------------
Â  Â  Â  Â  Â  Â  const maxScore = scoredMoves[0].score; // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ãªã®ã§ã€å…ˆé ­ã®ã‚¹ã‚³ã‚¢ãŒæœ€é«˜ç‚¹
Â  Â  Â  Â  Â  Â  // æœ€é«˜ã‚¹ã‚³ã‚¢ã‚’æŒã¤æ‰‹ã‚’ã™ã¹ã¦æŠ½å‡º
Â  Â  Â  Â  Â  Â  const bestMoves = scoredMoves.filter(move => move.score === maxScore);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let finalMove; // finalMove ã¯ {move: {r, c}, score: s} å½¢å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

Â  Â  Â  Â  Â  Â  // 1. åŒç‚¹ã®æ‰‹ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸€ã¤ã‚’é¸ã¶ï¼ˆã“ã‚ŒãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æœ€å–„æ‰‹ï¼‰
Â  Â  Â  Â  Â  Â  if (bestMoves.length > 1) {
Â  Â  Â  Â  Â  Â  Â  Â  const randomIndex = Math.floor(Math.random() * bestMoves.length);
Â  Â  Â  Â  Â  Â  Â  Â  finalMove = bestMoves[randomIndex];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  finalMove = bestMoves[0];Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ----------------------------------------------------
Â  Â  Â  Â  Â  Â  // 2. ç–²å¼Šãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
            // ----------------------------------------------------
Â  Â  Â  Â  Â  Â  const isImmediateWin = maxScore === WIN_SCORE; // maxScoreã‚’åˆ©ç”¨
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const moveNumberToPlay = moveCount + 1;Â 
Â  Â  Â  Â  Â  Â  const isFatigued = moveNumberToPlay >= FATIGUE_THRESHOLD;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // â˜… ä¿®æ­£1: æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã§ç–²åŠ´ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãŒç™ºç”Ÿã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ â˜…
Â  Â  Â  Â  Â  Â  const willAnnounceFatigueNextTurn = isFatigued && !hasAnnouncedFatigue && fatigueVoicePlayedCount === 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ç–²å¼Šãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†: æœ€é«˜ã‚¹ã‚³ã‚¢ã§ãªãã€æ¬¡å–„ã®æ‰‹ã‚’é¸ã¶ï¼ˆfinalMoveã‚’ä¸Šæ›¸ãï¼‰
Â  Â  Â  Â  Â  Â  if (isFatigued && !isImmediateWin && scoredMoves.length > 1) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.random() < FATIGUE_ERROR_CHANCE) {
                    // â˜… ä¿®æ­£: finalMoveã‚’scoredMoves[1]ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ï¼‰ã§ä¸Šæ›¸ã
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalMove = scoredMoves[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`AI Fatigue: Chose 2nd best move. Error Chance: ${FATIGUE_ERROR_CHANCE}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
            // ----------------------------------------------------
            // â˜…â˜…â˜… finalMoveã®æ±ºå®šçµ‚äº† â˜…â˜…â˜…
            // ----------------------------------------------------

Â  Â  Â  Â  Â  Â  // ä»¥ä¸‹ã®è¡Œã‹ã‚‰ã€finalMoveã®åº§æ¨™ã‚¢ã‚¯ã‚»ã‚¹ã‚’ finalMove.move.r/c ã«ä¿®æ­£
Â  Â  Â  Â  Â  Â  board[finalMove.move.r][finalMove.move.c] = PLAYER_AI;Â 
Â  Â  Â  Â  Â  Â  const isFinalMoveImmediateWin = checkWin(finalMove.move.r, finalMove.move.c, PLAYER_AI);
Â  Â  Â  Â  Â  Â  board[finalMove.move.r][finalMove.move.c] = 0;Â 

Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const isFinalMoveOpenFour = checkOpenFour(finalMove.move.r, finalMove.move.c, PLAYER_AI);Â 
Â  Â  Â  Â  Â  Â  const isSingleFourThreat = checkThreateningLine(finalMove.move.r, finalMove.move.c, PLAYER_AI);Â 


Â  Â  Â  Â  Â  Â  let threatType = null;

Â  Â  Â  Â  Â  Â  if (!isFinalMoveImmediateWin) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (isFinalMoveOpenFour) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  threatType = 'win_confirmed';
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (threatType === null && isSingleFourThreat && !isFinalMoveImmediateWin) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  threatType = 'reach';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // å‹ã¡ç¢ºå®šãƒ•ãƒ©ã‚°ã‚ªãƒ³
Â  Â  Â  Â  Â  Â  if (threatType === 'win_confirmed') {
Â  Â  Â  Â  Â  Â  Â  Â  // æ´»å››ãŒæˆç«‹ã—ãŸå ´åˆã€å‹ã¡ç¢ºå®šãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  aiGuaranteedWin = true; // â† å¤‰æ•°åã‚’ threatType ã«åˆã‚ã›ã¾ã—ãŸ
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (thinkingIndicator) thinkingIndicator.textContent = "";Â 
Â  Â  Â  Â  Â  Â Â 
            if (threatType === 'win_confirmed') {
Â  Â  Â  Â  Â  Â  Â  Â  const winMsg = getRandomMessage('WIN_CONFIRMED');
Â  Â  Â  Â  Â  Â  Â  Â  
                // â˜…â˜…â˜… ä¿®æ­£: é»’ãŒç¢ºå®šãƒªãƒ¼ãƒã§ãªã„å ´åˆã®ã¿ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨éŸ³å£°ã‚’å†ç”Ÿ â˜…â˜…â˜…
                if (!isPlayerGuaranteedWin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(winMsg, 'win_confirmed');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playVoice(MESSAGE_VOICE_MAP[winMsg], 1.0);Â 
                }
                // â˜…â˜…â˜… ------------------------------------------------------------- â˜…â˜…â˜…
                
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 800));Â 
Â  Â  Â  Â  Â  Â  } else if (threatType === 'reach') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const reachMsg = getRandomMessage('REACH');
Â  Â  Â  Â  Â  Â  Â  Â  
                // â˜…â˜…â˜… ä¿®æ­£: é»’ãŒç¢ºå®šãƒªãƒ¼ãƒã§ãªã„å ´åˆã®ã¿ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨éŸ³å£°ã‚’å†ç”Ÿ â˜…â˜…â˜…
                if (!isPlayerGuaranteedWin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(reachMsg, 'reach');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playVoice(MESSAGE_VOICE_MAP[reachMsg], 1.0);Â 
                }
                // â˜…â˜…â˜… ------------------------------------------------------------- â˜…â˜…â˜…
                
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 800));Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!gameActive) { if (thinkingIndicator) thinkingIndicator.textContent = ""; return; }Â 

Â  Â  Â  Â  Â  Â  // â˜… ä¿®æ­£2: è„…å¨ãƒœã‚¤ã‚¹ãŒãªã„ AND æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã§ç–²åŠ´ãƒœã‚¤ã‚¹ãŒãªã„å ´åˆã«ã®ã¿ã€ãƒ©ãƒ³ãƒ€ãƒ éŸ³å£°å†ç”Ÿ â˜…
Â  Â  Â  Â  Â  Â  // threatTypeãŒãªã„ ã‹ã¤ã€æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã§ã€Œç–²åŠ´ãƒœã‚¤ã‚¹ãŒå†ç”Ÿã•ã‚Œã‚‹äºˆå®šãŒãªã„ã€å ´åˆã«ã®ã¿ã€AIã®ãƒ©ãƒ³ãƒ€ãƒ ãªã€ŒçŸ³ã‚’ç½®ãéŸ³ã€ã‚’å†ç”Ÿã—ã¾ã™ã€‚
Â  Â  Â  Â  Â  Â  if (threatType === null && !willAnnounceFatigueNextTurn && !isFinalMoveImmediateWin) { 
Â  Â  Â  Â  Â  Â  Â  Â  // ğŸ’¡ å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯: AIãŒçŸ³ã‚’ç½®ãç›´å‰ã«ã€30%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ éŸ³å£°å†ç”Ÿ
Â  Â  Â  Â  Â  Â  Â  Â  playVoice(PUT_VOICES, VOICE_CHANCE_PUT);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await placePiece(finalMove.move.r, finalMove.move.c, PLAYER_AI, threatType); // â˜…ä¿®æ­£ï¼šåº§æ¨™ã‚¢ã‚¯ã‚»ã‚¹

Â  Â  Â  Â  Â  Â  if (gameActive) {
                
                // â˜…â˜…â˜… NEW/FIX: AIç€æ‰‹å¾Œã®ãƒ”ãƒ³ãƒçŠ¶æ…‹ã®å†ãƒã‚§ãƒƒã‚¯ã¨ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  Â  Â  if (checkBoardForLiveFour(PLAYER_HUMAN)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // AIãŒæ‰“ã£ãŸå¾Œã‚‚æ´»å››ãŒç¶™ç¶šã—ã¦ã„ã‚‹å ´åˆï¼ˆAIã®ãƒŸã‚¹ã€ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåŒæ™‚ã«è¤‡æ•°æ´»å››ã‚’ä½œã£ã¦ã„ãŸï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPlayerGuaranteedWin = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // AIãŒæ´»å››ã‚’æ­£ã—ããƒ–ãƒ­ãƒƒã‚¯ã—ãŸå ´åˆã€ãƒ”ãƒ³ãƒè§£é™¤
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPlayerGuaranteedWin = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updatePinchOverlay(); // ç”»åƒã‚’æ›´æ–°

Â  Â  Â  Â  Â  Â  Â  Â  // placePieceã§moveCountãŒå¢—ãˆã¦ã„ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  const isCurrentFatigued = (moveCount) >= FATIGUE_THRESHOLD;Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // â˜… NEW: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹ã¡ç¢ºå®šçŠ¶æ…‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  // humanThreatTypeã‚’ç›´æ¥å‚ç…§ã§ããªã„ãŸã‚ã€ç¾åœ¨ã®ç›¤é¢ã‹ã‚‰å†ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€å¾Œã®ç€æ‰‹ã¯ finalMove ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¿ãƒ¼ãƒ³ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸç›´å¾Œã®ç›¤é¢ã‚’è©•ä¾¡ã—ã¾ã™ã€‚
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // AIã®ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã—ã€æ¬¡ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚‹ç›´å‰ã€
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ã®æ´»å››ï¼ˆWIN_CONFIRMEDï¼‰ãŒç¶šã„ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  const humanThreatAfterAITurn = checkThreatsAcrossBoard(PLAYER_HUMAN);

Â  Â  Â  Â  Â  Â  Â  Â  if (!threatType) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ä¿®æ­£: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹ã¡ç¢ºå®šï¼ˆWIN_CONFIRMEDï¼‰ã®çŠ¶æ…‹ã§ãªã„å ´åˆã«ã®ã¿ã€è¡¨æƒ…ã‚’æˆ»ã™
                    if (!isPlayerGuaranteedWin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // è„…å¨ãŒãªã„å ´åˆã®ã¿ã€è¡¨æƒ…ã‚’æˆ»ã™
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isCurrentFatigued) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚Œã° tired ã«æˆ»ã™
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setCharacterMood('tired', 'tired'); // moodTypeã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
Â  Â  Â   Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // éç–²åŠ´ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚Œã° smile ã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setCharacterMood('smile', 'smile'); // moodTypeã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 500));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹ã¡ç¢ºå®šã®çŠ¶æ…‹ãªã‚‰ã€ãƒ”ãƒ³ãƒé¡”ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«å¾…æ©Ÿã®ã¿è¡Œã†
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 3000));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
                }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
        
        // --- è£œåŠ©é–¢æ•° ---

        function isDraw() { 
            return moveCount === BOARD_SIZE * BOARD_SIZE;
        }

        // --- è‡ªå‹•å†ç”Ÿåˆ¶é™å›é¿ãƒ­ã‚¸ãƒƒã‚¯ ---
        let audioContextUnlocked = false;

        function unlockAudio() {
            if (audioContextUnlocked) return;
            
            // Audio ContextãŒå­˜åœ¨ã™ã‚‹å ´åˆã€å†é–‹ã‚’è©¦ã¿ã‚‹ (ã‚ˆã‚Šãƒ¢ãƒ€ãƒ³ãªæ–¹æ³•)
            if (window.AudioContext && !window.audioCtx) {
                 window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (window.audioCtx && window.audioCtx.state === 'suspended') {
                window.audioCtx.resume().then(() => {
                    console.log("Audio Context resumed successfully.");
                    audioContextUnlocked = true;
                    // ä¸€åº¦è§£é™¤ã•ã‚ŒãŸã‚‰ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                    document.removeEventListener('click', unlockAudio, true);
                    document.removeEventListener('touchend', unlockAudio, true);
                    
                    // â˜…â˜…â˜… NEW: AudioContextãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‚‰BGMã®å†ç”Ÿã‚‚è©¦ã¿ã‚‹ â˜…â˜…â˜…
                    if (gameBGM && gameBGM.paused && !isMuted && bgmVolume > 0) {
                         gameBGM.play().catch(e => console.warn("BGM play failed after unlock:", e.message));
                    }
                    
                }).catch(e => console.error("Error resuming AudioContext:", e));
                return;
            }

            // å¾“æ¥ã®Audioè¦ç´ ã‚’ä½¿ç”¨ã—ãŸæ–¹æ³• (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
            // ç„¡éŸ³ã®Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¦å†ç”Ÿã—ã€å³æ™‚åœæ­¢ã™ã‚‹
            // â˜… æ³¨: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿéš›ã«æ“ä½œã™ã‚‹ã¾ã§ã€ã“ã®play()ã¯å¤±æ•—ã™ã‚‹ã“ã¨ãŒå¤šã„ãŒã€
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå†ç”Ÿã®è¨±å¯ã‚’å¾—ã‚‹ãŸã‚ã®å‘¼ã³å‡ºã—ã¨ã—ã¦æ®‹ã™ã€‚
            const url = VOICE_BASE_URL + PUT_VOICES[0];
            const silentAudio = new Audio(url);
            silentAudio.volume = 0; 
            
            silentAudio.play().then(() => {
                console.log("Audio unlocked successfully via silent play.");
                audioContextUnlocked = true;
                // ä¸€åº¦è§£é™¤ã•ã‚ŒãŸã‚‰ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                document.removeEventListener('click', unlockAudio, true);
                document.removeEventListener('touchend', unlockAudio, true);
                
                // â˜…â˜…â˜… NEW: å¾“æ¥ã®Audioè¦ç´ ã§ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ™‚ã‚‚BGMã®å†ç”Ÿã‚’è©¦ã¿ã‚‹ â˜…â˜…â˜…
                if (gameBGM && gameBGM.paused && !isMuted && bgmVolume > 0) {
                    gameBGM.play().catch(e => console.warn("BGM play failed after silent unlock:", e.message));
                }
                
            }).catch(e => {
                // console.log("Audio unlock failed, browser still blocking or already unlocked.");
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€åˆã«æ“ä½œã—ãŸã¨ãã« unlockAudio ã‚’å®Ÿè¡Œ
        // capture: true ã§ã€ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚ˆã‚Šå…ˆã«ã‚­ãƒ£ãƒƒãƒã™ã‚‹
        document.addEventListener('click', unlockAudio, true);
        document.addEventListener('touchend', unlockAudio, true);
        
    </script>
    <body class="bg-gray-100 h-screen flex flex-col items-center justify-start py-2 px-2 font-sans overflow-hidden">
    <div id="start-screen" style="display: flex;">
    <img alt="ã‚¿ã‚¤ãƒˆãƒ«" class="mb-8" id="title-image" src="https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/title.png" style="width: 70vw; max-width: 512px;"/>
    <img alt="èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ" class="mb-12 pointer-events-none" id="text-image" src="https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/text.png" style="width: 70vw; max-width: 400px;"/>
    <img alt="ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³" class="transition-transform duration-150 ease-in-out transform hover:scale-105 active:scale-95 cursor-pointer" id="start-button" src="https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/start.png" style="width: 45vw; max-width: 300px;"/>
    <div id="copyright-info" class="text-xs mt-8 mb-4 text-white bg-black bg-opacity-60 px-2 py-1 rounded">
Â  Â  Â© 2025 ã‚«ã‚­ãƒã‚­|
Â  Â  <a href="#" id="open-license-modal" class="hover:underline text-white">åˆ©ç”¨è¦ç´„</a>|
Â  Â  éŸ³å£°ãƒ»ã‚¢ã‚»ãƒƒãƒˆã®ç„¡æ–­åˆ©ç”¨ç¦æ­¢
Â  Â  </div>
    </div>
    <div class="w-full h-full relative flex flex-col items-center justify-start" id="game-wrapper">

    <canvas id="rainCanvas"></canvas>
    <div class="max-w-2xl w-full flex flex-col items-center p-2 relative z-10" id="game-container">
    <div class="gradient-polka-dots">
    </div>
    <div class="flex items-center justify-center space-x-2 w-full pt-1 pb-1 flex-shrink-0">
    </div>
    <div class="relative flex justify-center px-4 flex-shrink-0" id="character-and-message" style="max-width: min(90vw, 450px); width: 100%; margin: 0 auto; height: 400px; align-items: flex-end; padding-bottom: 0;">
    <div class="relative" id="char-image-container">
    <img alt="AIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ ã‚¢ãƒ¡ãƒŸãƒ¤ãƒã‚«" class="h-auto rounded-lg object-contain relative z-15" id="char-image" src="https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/amemiya_normal.png" style="min-width: 100px;"/>
    <img id="pinch-overlay-image" 
        src="https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/amemiya_pinch01.png" 
        alt="ãƒ”ãƒ³ãƒè¡¨æƒ…ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤" 
        style="
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            /* æ—¢å­˜ã®char-image(z-index: 15)ã®ä¸Šã«é‡ã­ã‚‹ */
            z-index: 20;
        "/>
    <img alt="ã¦ã‚‹ã—ãƒ¼" id="terushi" src="https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/teru.png" style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:200px;z-index:25;display:none;cursor:pointer;animation:float 3s ease-in-out infinite;"/></div>
    
    <div id="right-icons-container">
        <div id="audio-control-icon" style="display: none;">
            <div id="audio-icon">
                </div>
            <div id="audio-settings-menu">
                <h4 class="text-sm font-bold text-gray-700 mb-1">éŸ³å£°è¨­å®š</h4>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-600" for="bgm-volume-slider">BGM éŸ³é‡</label>
                    <input class="w-full" id="bgm-volume-slider" max="100" min="0" type="range" value="20"/>
                </div>
                <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-600" for="se-voice-volume-slider">åŠ¹æœéŸ³ãƒ»éŸ³å£° éŸ³é‡</label>
                    <input class="w-full" id="se-voice-volume-slider" max="100" min="0" type="range" value="80"/>
                </div>
            </div>
        </div>
        
        <div id="link-icon">
            </div>
    </div>
<div class="absolute z-20 md:w-80 w-[90%] p-3 rounded-xl shadow-2xl transition-colors duration-300 bg-blue-500 text-white shadow-blue-500/80 left-1/2 -translate-x-1/2 bottom-2" id="speech-bubble">
<p class="font-semibold text-sm" id="status-text">å¯¾å±€é–‹å§‹ï¼ã‚ãªãŸï¼ˆé»’ï¼‰ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚</p>
<p class="text-sm mt-1" id="timer">æŒã¡æ™‚é–“: 10ç§’</p>
<div class="w-full h-4 text-center text-white font-bold transition-opacity duration-300 text-xs mt-1" id="thinking-indicator">
</div>
</div>
</div>
<div class="flex w-full justify-center max-w-5xl flex-grow" id="game-area">
<div class="flex flex-col items-center max-w-full justify-center h-full relative" id="board-wrapper">
<div class="board-grid" id="board">
</div>
<div id="reset-button-container" class="transition duration-150 ease-in-out transform" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; cursor: pointer;">
    <img id="modal-reset-button"
         src="https://raw.githubusercontent.com/kakinoki-meisaku/gomoku-game/main/assets/images/amagumo.png"
         alt="ã‚‚ã†ä¸€å›"
         class="w-[100px] mx-auto hover:scale-105 active:scale-95 transition duration-150 ease-in-out" />
</div>
</div>
</div>
</div>
</div>
</div>


<script>
// === ã¦ã‚‹ã—ãƒ¼ã‚®ãƒŸãƒƒã‚¯ Ver.3 ===
let terushiVisible = false;
const terushiElement = document.getElementById('terushi');

// switchTurnãƒ•ãƒƒã‚¯ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«å‡ºç¾ï¼‰
const originalSwitchTurn = window.switchTurn;
if (originalSwitchTurn) {
  window.switchTurn = async function(threatType = null) {
    const result = await originalSwitchTurn.call(this, threatType);
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆè‡ªåˆ†ï¼‰ã®ã‚¿ãƒ¼ãƒ³ã«ãªã£ãŸç›´å¾Œã«å‡ºç¾åˆ¤å®š
    if (currentPlayer === PLAYER_HUMAN && gameActive) {
    
		// 1. AIãŒå‹ã¡ç¢ºå®šï¼ˆaiGuaranteedWin = trueï¼‰ã®å ´åˆã¯ã€ã¦ã‚‹ã—ãƒ¼ã‚’çµ¶å¯¾ã«å‡ºç¾ã•ã›ãªã„
        if (typeof aiGuaranteedWin !== 'undefined' && aiGuaranteedWin) {
            terushiVisible = false;
            terushiElement.style.display = 'none';
            return result; // å‡ºç¾å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦çµ‚äº†
        }
        
        // 2. moveCountãŒ4æœªæº€ï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹ç›´å¾Œã®æ•°æ‰‹ï¼‰ã®å ´åˆã¯å‡ºç¾ã•ã›ãªã„
        if (typeof moveCount === 'number' && moveCount < 4) {
            terushiVisible = false;
            terushiElement.style.display = 'none';
            return result; // å‡ºç¾å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦çµ‚äº†
        }
    
      if (Math.random() < 0.1) {
        terushiVisible = true;
        terushiElement.style.display = 'block';
        if (timerElement) {
          timerElement.innerHTML = '<span class="text-white-500 font-bold text-lg">ã¦ã‚‹ã—ãƒ¼å‡ºç¾ä¸­ï¼</span>';
        }
      } else {
        terushiVisible = false;
        terushiElement.style.display = 'none';
      }
    }
    return result;
  };
}

// placePiece ãƒ•ãƒƒã‚¯
const originalPlacePiece = window.placePiece;
if (originalPlacePiece) {
  window.placePiece = async function(r, c, player, threatType = null) {
    // ãƒ†ãƒ«ã‚·ãƒ¼ç„¡è¦–
    if (player === PLAYER_HUMAN && terushiVisible) {
      gameActive = false;
      isPlayerGuaranteedWin = false;
      updatePinchOverlay();
      updateStatus('ã€æ•—åŒ—ã€‘ã¦ã‚‹ã—ãƒ¼ã‚’ç„¡è¦–ã—ã¦ã—ã¾ã„ã¾ã—ãŸâ€¦', 'loss');
      // BGMã‚’åœæ­¢ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
      stopBGM();
      playSE(TERU_NG_SE_URL, TERU_SE_VOLUME_DEFAULT);
      playVoice(TETU_NG_VOICES, 1.0); // 100%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ
            
      // ãƒ†ãƒ«ã‚·ãƒ¼å­˜åœ¨ã‚¢ãƒ”ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
Â  Â        const terushi = document.getElementById('terushi');
Â  Â        if (terushi) {
Â  Â  Â  Â        // æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
Â  Â  Â  Â        terushi.classList.add('terushi-loss-assert-active');
Â  Â        }
Â  Â    // ãƒ†ãƒ«ã‚·ãƒ¼å­˜åœ¨ã‚¢ãƒ”ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  (ã“ã“ã¾ã§) 
      
      // ã¦ã‚‹ã—ãƒ¼ã¯è¡¨ç¤ºã•ã‚ŒãŸã¾ã¾
      setTimeout(showResetButton, 2000);
      return;
    }
    
    // ãƒ”ãƒ³ãƒã‚®ãƒŸãƒƒã‚¯
    // 1. å…ƒã®é§’ã‚’ç½®ãå‡¦ç†ã‚’å®Ÿè¡Œ (çŸ³ãŒç›¤é¢ã«ç½®ã‹ã‚Œã€å‹åˆ©åˆ¤å®šã‚‚ã“ã“ã§è¡Œã‚ã‚Œã‚‹)
    const result = await originalPlacePiece.call(this, r, c, player, threatType);
    
    // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼(é»’)ã®ã‚¿ãƒ¼ãƒ³ã§ã€ã‹ã¤ã‚²ãƒ¼ãƒ ãŒç¶šè¡Œä¸­ã®å ´åˆã®ã¿ã€ãƒªãƒ¼ãƒã‚’ãƒã‚§ãƒƒã‚¯
    if (player === PLAYER_HUMAN && gameActive) { 
        // gameActive ã¯å…ƒã® placePiece å†…ã§å‹åˆ©ã—ãŸå ´åˆã¯ false ã«ãªã£ã¦ã„ã‚‹ã¯ãš

        // AIã®å‹ã¡ç¢ºãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªãƒ¼ãƒã‚’ç„¡è¦–ã—ã¦å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (aiGuaranteedWin) {
            // console.log("AIãŒå‹ã¡ç¢ºã®ãŸã‚ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªãƒ¼ãƒã«ã‚ˆã‚‹ãƒ”ãƒ³ãƒé¡”è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚");
            return result; // å…ƒã®å‡¦ç†ã®çµæœã‚’è¿”ã—ã¦çµ‚äº†
        }
        //

        const humanThreatType = checkHumanThreats(r, c); 
        if (humanThreatType !== 'NONE') {
            let pinchImageUrl;
            if (humanThreatType === 'WIN_CONFIRMED') {
                // æ´»å››ã‚ˆã‚‹å‹ç¢ºæ™‚ -> amemiya_pinch01.png
                pinchImageUrl = PINCH_01_URL; 
                playVoice(PINCH_VOICES, 1.0); // 100%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ
            } else if (humanThreatType === 'REACH') {
                // å˜ä¸€ã®å››é€£ã«ã‚ˆã‚‹ãƒªãƒ¼ãƒæ™‚ -> amemiya_pinch02.png
                pinchImageUrl = PINCH_02_URL; 
                playVoice(SHOCK_VOICES, 1.0); // 100%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ
            }
            
            // ã‚¢ãƒ¡ãƒŸãƒ¤ãƒã‚«ã®ç”»åƒã‚’2ç§’é–“åˆ‡ã‚Šæ›¿ãˆã‚‹
            if (pinchImageUrl) {
                 displayPinchImage(pinchImageUrl); // ã“ã®é–¢æ•°ãŒãƒ”ãƒ³ãƒé¡”ã‚’è¨­å®šã™ã‚‹
                // â˜… NEW: ãƒ”ãƒ³ãƒé¡”ãŒè¡¨ç¤ºã•ã‚ŒãŸã®ã§ã€æ€è€ƒä¸­ã‚‚ã“ã®é¡”ã‚’ç¶­æŒã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                isPinchThinking = true;
            }
        }
    }
    return result; // å…ƒã®å‡¦ç†ã®çµæœã‚’è¿”ã™
  };
}

// ã¦ã‚‹ã—ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§æ¶ˆã™ (ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã)
if (terushiElement) {
Â  terushiElement.addEventListener('click', function() {
    // æ—¢ã«æ¶ˆãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®å†ã‚¯ãƒªãƒƒã‚¯ãªã©ã‚’é˜²ããŸã‚ã«ãƒã‚§ãƒƒã‚¯
    if (!terushiVisible || terushiElement.classList.contains('terushi-slide-out')) {
        return; 
    }
    
    // ã‚²ãƒ¼ãƒ ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    // if (!gameActive) { return; } 

    // 1. ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã€transform ã®åˆ¶å¾¡æ¨©ã‚’å¥ªã†ã€‚
    // ï¼ˆã“ã®ã‚¯ãƒ©ã‚¹å†…ã® animation: none !important; ã§ã€å…¨ã¦ã® animation ã‚’åœæ­¢ã•ã›ã‚‹ï¼‰
Â  Â  terushiElement.classList.add('terushi-slide-out');
    
    // 2. è² ã‘æ™‚ã®ã‚¢ãƒ”ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒ©ã‚¹ã¯ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå§‹ã¾ã£ã¦ã‹ã‚‰å‰Šé™¤ã™ã‚‹ã€‚
    //    ã‚ã‚‹ã„ã¯ã€CSSã§ animation: none !important; ãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ã‚’ä¿¡ã˜ã¦ã€ã“ã®è¡Œã¯ç¾çŠ¶ç¶­æŒã€‚
    terushiElement.classList.remove('terushi-loss-assert-active'); // ã“ã®è¡Œã®ä½ç½®ã¯ã“ã“ã§OK
    
Â  Â  // 3. SEã¨ãƒœã‚¤ã‚¹
Â  Â  playSE(TERU_OK_SE_URL, TERU_SE_VOLUME_DEFAULT);
Â  Â  playVoice(TETU_OK_VOICES, 1.0); // 100%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ
    
Â  Â  // 4. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã®å‡¦ç† (0.5ç§’å¾Œã«å®Ÿè¡Œ)
    // CSSã® transition: 0.5s ã«åˆã‚ã›ã¦ 500ms ã‚’è¨­å®š
Â  Â  setTimeout(() => {
        // å®Œå…¨ã«éè¡¨ç¤ºã«ã™ã‚‹
        terushiElement.style.display = 'none';
        
        // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¦ã€æ¬¡ã®è¡¨ç¤ºã«å‚™ãˆã‚‹
        terushiElement.classList.remove('terushi-slide-out');

        // ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
        terushiVisible = false;

        // ã‚¿ã‚¤ãƒãƒ¼ã®ãƒªã‚»ãƒƒãƒˆï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã«ã‚ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆéƒ¨åˆ†ï¼‰
        // if (timerElement) {
        //  timerElement.innerHTML = 'æ®‹ã‚Šæ™‚é–“: <span class="text-lg font-extrabold">' + TURN_TIME_LIMIT + '</span> ç§’';
        // }
        
        // ã€é‡è¦ã€‘ã‚²ãƒ¼ãƒ ã®ã€Œæ•‘æ¸ˆã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½è¨˜
        // ä¾‹: AIã®æ¬¡ã®æ‰‹ç•ªã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å‡¦ç†ãªã©...
        
Â  Â  }, 3000); 

Â  });
}

// ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆæ™‚ã®ã¦ã‚‹ã—ãƒ¼æ¶ˆå»
const originalInitializeGame = window.initializeGame;
if (originalInitializeGame) {
  window.initializeGame = function() {
    //aiGuaranteedWinãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆ
    if (typeof aiGuaranteedWin !== 'undefined') {
            aiGuaranteedWin = false;
        }    
        
    //isPinchThinkingãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆ
        if (typeof isPinchThinking !== 'undefined') {
            isPinchThinking = false;
        }
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºå®šãƒªãƒ¼ãƒãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤º
    if (typeof isPlayerGuaranteedWin !== 'undefined') {
        isPlayerGuaranteedWin = false;
    }
    updatePinchOverlay(); // éè¡¨ç¤ºã‚’ç¢ºå®šã•ã›ã‚‹

    if (terushiElement) {
      terushiVisible = false;
      terushiElement.style.display = 'none';
      terushiElement.classList.remove('terushi-loss-assert-active');
    }
    return originalInitializeGame.call(this);
  };
}
</script>
<div id="license-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[100] items-center justify-center p-4" style="display: none;">
    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto relative">
        <button id="close-license-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-900 text-2xl font-bold">&times;</button>
        <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ã‚¢ãƒ¡ãƒŸãƒ¤ãƒã‚«ã¨äº”ç›®ãªã‚‰ã¹ åˆ©ç”¨æ¡ä»¶</h2>
        <div id="license-content" class="text-sm text-gray-700 space-y-4">
            </div>
    </div>
</div>
</body>
</html>